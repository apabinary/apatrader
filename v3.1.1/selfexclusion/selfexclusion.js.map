{"version":3,"sources":["../../../../src/selfexclusion/selfexclusion.es6"],"names":["win","timerHandlerForSessionTimeout","loginTime","limits","i18n","settingsData","max_balance","max_turnover","max_losses","max_7day_turnover","max_7day_losses","max_30day_turnover","max_30day_losses","max_open_bets","session_duration_limit","exclude_until","timeout_until_date","timeout_until_time","update","event","scope","data","message","time_out","add","format","isAfter","push","timeout_until","unix","each","index","value","set","utc","isBefore","startOf","limit","name","length","forEach","msg","i","growl","error","confirm","window","send","then","response","notice","logoutBasedOnExcludeDateAndTimeOut","setOrRefreshTimer","catch","err","console","init_win","require","Promise","res","div","find","datepicker","dateFormat","minDate","toDate","maxDate","timepicker","timeFormat","createBlankWindow","title","width","minHeight","height","destroy","appendTo","bind","refreshData","defer","invalidate","valueOf","get_self_exclusion","isUndefined","isNull","isFinite","toNumber","clearTimeout","logoutAfter_ms","now","Math","pow","setTimeout","warning","logout","dialog","addClass","events","on","cached","authorize","is_virtual","removeClass","init","$menuLink","click","hasClass","moveToTop"],"mappings":"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","file":"selfexclusion.js","sourcesContent":["/**\r\n * Created by arnab on 4/5/16.\r\n */\r\nimport $ from \"jquery\";\r\nimport windows from \"windows/windows\";\r\nimport liveapi from \"websockets/binary_websockets\";\r\nimport _ from \"lodash\";\r\nimport rv from \"common/rivetsExtra\";\r\nimport moment from \"moment\";\r\nimport html from \"text!selfexclusion/selfexclusion.html\";\r\nimport \"jquery-growl\";\r\nimport \"common/util\";\r\n\r\n\r\nlet win = null,\r\n    timerHandlerForSessionTimeout = null,\r\n    loginTime = null;\r\nconst limits = {\r\n    \"max_balance\": {\r\n        \"limit\": 99999999999999999999,\r\n        \"set\": false,\r\n        \"name\": \"Maximum balance\".i18n()\r\n    },\r\n    \"max_turnover\": {\r\n        \"limit\": 99999999999999999999,\r\n        \"set\": false,\r\n        \"name\": \"Daily turnover limit\".i18n()\r\n    },\r\n    \"max_losses\": {\r\n        \"limit\": 99999999999999999999,\r\n        \"set\": false,\r\n        \"name\": \"Daily limit on losses\".i18n()\r\n    },\r\n    \"max_7day_turnover\": {\r\n        \"limit\": 99999999999999999999,\r\n        \"set\": false,\r\n        \"name\": \"7-day turnover limit\".i18n()\r\n    },\r\n    \"max_7day_losses\": {\r\n        \"limit\": 99999999999999999999,\r\n        \"set\": false,\r\n        \"name\": \"7-day limit on losses\".i18n()\r\n    },\r\n    \"max_30day_turnover\": {\r\n        \"limit\": 99999999999999999999,\r\n        \"set\": false,\r\n        \"name\": \"30-day turnover limit\".i18n()\r\n    },\r\n    \"max_30day_losses\": {\r\n        \"limit\": 99999999999999999999,\r\n        \"set\": false,\r\n        \"name\": \"30-day limit on losses\".i18n()\r\n    },\r\n    \"max_open_bets\": {\r\n        \"limit\": 101,\r\n        \"set\": false,\r\n        \"name\": \"Maximum open positions\".i18n()\r\n    },\r\n    \"session_duration_limit\": {\r\n        \"limit\": 60480,\r\n        \"set\": false,\r\n        \"name\": \"Session duration limit\".i18n()\r\n    },\r\n    \"exclude_until\": {\r\n        \"limit\": null,\r\n        \"set\": false,\r\n        \"name\": \"Exclude time\".i18n()\r\n    },\r\n    \"timeout_until\": {\r\n        \"limit\": null,\r\n        \"set\": false,\r\n        \"name\": \"Time out until\".i18n()\r\n    }\r\n};\r\n\r\nconst settingsData = {\r\n    max_balance: null,\r\n    max_turnover: null,\r\n    max_losses: null,\r\n    max_7day_turnover: null,\r\n    max_7day_losses: null,\r\n    max_30day_turnover: null,\r\n    max_30day_losses: null,\r\n    max_open_bets: null,\r\n    session_duration_limit: null,\r\n    exclude_until: null,\r\n    timeout_until_date: null,\r\n    timeout_until_time: null,\r\n    update: function(event, scope) {\r\n\r\n        const data = { \"set_self_exclusion\": 1 };\r\n        let message = [];\r\n\r\n        if (scope.timeout_until_date) {\r\n            const time_out = moment(scope.timeout_until_date);\r\n            if (scope.timeout_until_time) {\r\n                time_out.add(scope.timeout_until_time.format('HH'), 'hours')\r\n                    .add(scope.timeout_until_time.format('mm'), 'minutes')\r\n            }\r\n            if (time_out.isAfter(moment().add(6, \"weeks\"))) {\r\n                message.push(\"Please enter a value less than 6 weeks for time out until.\".i18n());\r\n            }\r\n            if (!time_out.isAfter(moment())) {\r\n                message.push(\"Exclude time must be after today.\".i18n());\r\n            }\r\n            scope.timeout_until = time_out.unix();\r\n        } else {\r\n            if (scope.timeout_until_time) {\r\n                message.push(\"Please select a date for time out until.\".i18n());\r\n            }\r\n        }\r\n\r\n\r\n        //validation\r\n        $.each(limits, function(index, value) {\r\n            if (scope[index] || value.set) {\r\n                if (index === \"exclude_until\" && moment.utc(scope.exclude_until, \"YYYY-MM-DD\").isBefore(moment.utc().startOf('day').add(6, \"months\"))) {\r\n                    message.push(\"Exclude until time cannot be less than 6 months.\".i18n());\r\n                    return;\r\n                }\r\n                if (!scope[index] || scope[index] <= 0 || (value.limit && scope[index] > value.limit)) {\r\n                    message.push(\"Please enter a value between 0 and \".i18n() + value.limit + \" for \".i18n() + value.name);\r\n                    return;\r\n                }\r\n                data[index] = scope[index];\r\n            }\r\n        });\r\n\r\n        if (message.length > 0) {\r\n            message.forEach(function(msg, i) {\r\n                $.growl.error({ message: msg });\r\n            })\r\n            return;\r\n        }\r\n        if (data.timeout_until || data.exclude_until) {\r\n            const confirm = window.confirm(\"When you click \\\"Ok\\\" you will be excluded from trading on the site until the selected date.\".i18n());\r\n            if (confirm == false) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        liveapi.send(data)\r\n            .then(function(response) {\r\n                $.growl.notice({ message: 'Your changes have been updated'.i18n() });\r\n                logoutBasedOnExcludeDateAndTimeOut();\r\n                setOrRefreshTimer();\r\n            })\r\n            .catch(function(err) {\r\n                $.growl.error({ message: err.message });\r\n                console.error(err);\r\n            });\r\n    }\r\n};\r\n\r\nconst init_win = function() {\r\n    require([\"css!selfexclusion/selfexclusion.css\"]);\r\n    return new Promise(function(res) {\r\n        const div = $(html).i18n();\r\n        div.find(\".datepicker\").datepicker({\r\n            dateFormat: 'yy-mm-dd',\r\n            minDate: moment.utc().toDate(),\r\n            maxDate: moment.utc().add(6, \"weeks\").toDate()\r\n        });\r\n        div.find(\".timepicker\").timepicker({\r\n            timeFormat: 'HH:MM'\r\n        });\r\n        win = windows.createBlankWindow($('<div/>'), {\r\n            title: 'Self-Exclusion Facilities'.i18n(),\r\n            width: 900,\r\n            minHeight: 500,\r\n            height: 500,\r\n            'data-authorized': 'true',\r\n            destroy: function() {\r\n                win = null;\r\n            }\r\n        });\r\n        div.appendTo(win);\r\n        rv.bind(div[0], settingsData);\r\n        refreshData();\r\n        res();\r\n    });\r\n};\r\n\r\nfunction logoutBasedOnExcludeDateAndTimeOut() {\r\n    if (settingsData.exclude_until) {\r\n        if (moment.utc(settingsData.exclude_until, 'YYYY-MM-DD').isAfter(moment.utc().startOf('day'))) {\r\n            _.defer(function() {\r\n                $.growl.error({ message: 'You have excluded yourself until '.i18n() + settingsData.exclude_until });\r\n                liveapi.invalidate();\r\n            });\r\n        }\r\n    }\r\n    if (settingsData.timeout_until) {\r\n        if (moment(settingsData.timeout_until).isAfter(moment().unix().valueOf())) {\r\n            $.growl.error({ message: 'You have excluded yourself until '.i18n() + moment.unix(settingsData.timeout_until).utc().format(\"YYYY-MM-DD HH:mm\") + \"GMT\" });\r\n            liveapi.invalidate();\r\n        }\r\n    }\r\n}\r\n\r\nconst refreshData = function() {\r\n    $.growl.notice({ message: 'Loading self-exclusion settings.'.i18n() });\r\n    return liveapi\r\n        .send({ get_self_exclusion: 1 })\r\n        .then(function(response) {\r\n            if (response.get_self_exclusion) {\r\n                $.each(limits, function(index, value) {\r\n                    settingsData[index] = response.get_self_exclusion[index];\r\n                    if (response.get_self_exclusion[index]) {\r\n                        limits[index].limit = response.get_self_exclusion[index];\r\n                        limits[index].set = true;\r\n                    }\r\n                });\r\n\r\n                logoutBasedOnExcludeDateAndTimeOut();\r\n            }\r\n        })\r\n        .catch(function(err) {\r\n            $.growl.error({ message: err.message });\r\n            console.error(err);\r\n        });\r\n};\r\n\r\nconst setOrRefreshTimer = function() {\r\n\r\n    if (_.isUndefined(settingsData.session_duration_limit) || _.isNull(settingsData.session_duration_limit) || !_.isFinite(_.toNumber(settingsData.session_duration_limit))) return;\r\n\r\n    if (timerHandlerForSessionTimeout) clearTimeout(timerHandlerForSessionTimeout);\r\n    let logoutAfter_ms = settingsData.session_duration_limit * 60 * 1000;\r\n    //reduce time elapsed since login\r\n    logoutAfter_ms -= _.now() - loginTime;\r\n    //setTimeout works with 32 bit value. Anything more than that does not work. 32 bit value is around 49 days\r\n    //User cannot be active on website for 49 days, so we are setting the session time out to 49 days max\r\n    if (logoutAfter_ms > Math.pow(2, 32)) { logoutAfter_ms = Math.pow(2, 32); }\r\n    timerHandlerForSessionTimeout = setTimeout(function() {\r\n        $.growl.warning({ message: 'Logging out because of self-exclusion session time out!'.i18n() });\r\n        liveapi.invalidate();\r\n    }, logoutAfter_ms);\r\n\r\n};\r\n\r\nconst logout = function() {\r\n    if (win) win.dialog('destroy');\r\n    win = null;\r\n    if (timerHandlerForSessionTimeout) clearTimeout(timerHandlerForSessionTimeout)\r\n    timerHandlerForSessionTimeout = null;\r\n    loginTime = null;\r\n    settingsData.max_balance = null;\r\n    settingsData.max_turnover = null;\r\n    settingsData.max_losses = null;\r\n    settingsData.max_7day_turnover = null;\r\n    settingsData.max_7day_losses = null;\r\n    settingsData.max_30day_turnover = null;\r\n    settingsData.max_30day_losses = null;\r\n    settingsData.max_open_bets = null;\r\n    settingsData.session_duration_limit = null;\r\n    settingsData.exclude_until = null;\r\n    $(\"#nav-container a.selfexclusion\").addClass('disabled');\r\n};\r\n\r\nliveapi.events.on('login', function(data) {\r\n    liveapi.cached.authorize()\r\n        .then(function(data) {\r\n            if (!data.authorize.is_virtual) {\r\n                loginTime = _.now();\r\n                refreshData().then(function() {\r\n                    setOrRefreshTimer();\r\n                });\r\n                $(\"#nav-menu a.selfexclusion\").removeClass('disabled');\r\n            } else {\r\n                logout();\r\n            }\r\n        })\r\n        .catch(function(err) {\r\n            logout();\r\n        });\r\n});\r\nliveapi.events.on('logout', logout);\r\n\r\nexport const init = function($menuLink) {\r\n    $menuLink.click(function() {\r\n        if (!$(this).hasClass('disabled')) {\r\n            liveapi.cached.authorize()\r\n                .then(function() {\r\n                    if (!win) {\r\n                        init_win().then(function() {\r\n                            win.dialog('open');\r\n                        });\r\n                    } else {\r\n                        refreshData();\r\n                        win.moveToTop();\r\n                    }\r\n                })\r\n                .catch(function(err) {\r\n                    console.error(err);\r\n                });\r\n        }\r\n    });\r\n}\r\n\r\nexport default {\r\n    init\r\n}\r\n"]}