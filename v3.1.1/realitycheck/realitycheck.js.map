{"version":3,"sources":["../../../../src/realitycheck/realitycheck.es6"],"names":["win","timerHandler","promises","FIRST_SCREEN_HEIGHT","SECOND_SCREEN_HEIGHT","settingsData","timeOutInMins","local_storage","get","timeOutMin","timeOutMax","loginId","durationInMins","bought","turnOver","loginTime","sold","pnl","currentTime","open","potentialProfit","currency","continueTrading","event","scope","growl","error","message","i18n","dialog","set","accepted_time","utc","valueOf","setOrRefreshTimer","openStatement","require","statement","elem","find","init","click","logout","invalidate","resetWindow","showFirstScreen","winWidget","height","show","hide","clearTimeout","logoutAfter_ms","setTimeout","send","reality_check","then","data","is_virtual","durationIn_ms","start_time","max_durationIn_ms","duration","humanize","buy_count","buy_amount","format","sell_count","sell_amount","open_contract_count","potential_profit","moveToTop","Promise","resolve","cached","authorize","loginid","landing_company_details","landing_company_name","has_reality_check","html","div","createBlankWindow","title","width","minHeight","resizable","collapsable","minimizable","maximizable","closable","modal","closeOnEscape","ignoreTileAction","appendTo","append","bind","remove","catch","err","oauthLogin","p","push","all","events","on","realityCheck_fromStorage","timeout","Math","abs"],"mappings":"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","file":"realitycheck.js","sourcesContent":["/**\r\n * Created by arnab on 4/9/16.\r\n */\r\nimport $ from 'jquery';\r\nimport windows from '../windows/windows';\r\nimport liveapi from '../websockets/binary_websockets';\r\nimport rv from '../common/rivetsExtra';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport 'jquery-growl';\r\nimport '../common/util';\r\n\r\nlet win = null, timerHandler = null, promises= [];\r\nconst FIRST_SCREEN_HEIGHT = 260, SECOND_SCREEN_HEIGHT = 310;\r\nconst settingsData = {\r\n   timeOutInMins: (local_storage.get(\"realitycheck\") || {}).timeOutInMins || 10,\r\n   timeOutMin: 10, timeOutMax: 120,\r\n   loginId: null,\r\n   durationInMins: null,\r\n   bought: null,\r\n   turnOver: null,\r\n   loginTime: null,\r\n   sold: null,\r\n   pnl: null,\r\n   currentTime: null,\r\n   open: null,\r\n   potentialProfit: null,\r\n   currency: null,\r\n   continueTrading: (event, scope) => {\r\n      //Validate input\r\n      if (scope.timeOutInMins < scope.timeOutMin || scope.timeOutInMins > scope.timeOutMax) {\r\n         $.growl.error({ message : 'Please enter a number between '.i18n() + scope.timeOutMin + ' and '.i18n() + scope.timeOutMax });\r\n         return;\r\n      }\r\n      win.dialog('close');\r\n      local_storage.set(\"realitycheck\", { timeOutInMins : scope.timeOutInMins | 0, accepted_time : moment.utc().valueOf() });\r\n      setOrRefreshTimer(scope.timeOutInMins);\r\n   },\r\n   openStatement: () => {\r\n      require(['statement/statement'], (statement) => {\r\n         const elem = $(\"#nav-menu\").find(\"a.statement\");\r\n         statement.init(elem);\r\n         elem.click();\r\n      });\r\n   },\r\n   logout : () => liveapi.invalidate()\r\n};\r\n\r\nconst resetWindow = (showFirstScreen) => {\r\n   if(win) {\r\n      const winWidget = win.dialog('widget');\r\n      if (showFirstScreen) {\r\n         win.dialog({height: FIRST_SCREEN_HEIGHT});\r\n         winWidget.find('.realitycheck_firstscreen').show();\r\n         winWidget.find('.realitycheck_secondscreen').hide();\r\n      } else {\r\n         win.dialog({height: SECOND_SCREEN_HEIGHT});\r\n         winWidget.find('.realitycheck_firstscreen').hide();\r\n         winWidget.find('.realitycheck_secondscreen').show();\r\n      }\r\n   }\r\n}\r\n\r\nconst setOrRefreshTimer = (timeOutInMins) => {\r\n\r\n   if (timerHandler) clearTimeout(timerHandler);\r\n   const logoutAfter_ms = timeOutInMins * 60 * 1000;\r\n   timerHandler = setTimeout(() => {\r\n      liveapi\r\n         .send({ reality_check : 1 })\r\n         .then((data) => {\r\n            /*\r\n             * Showing the reality check popup only if the user is using his real account otherwise keeping it minimized.\r\n             */\r\n            if(local_storage.get(\"authorize\").is_virtual) return;\r\n            let durationIn_ms = moment.utc().valueOf() - data.reality_check.start_time * 1000;\r\n            const max_durationIn_ms = 48 * 60 * 60 * 1000;\r\n            if (durationIn_ms > max_durationIn_ms) durationIn_ms = max_durationIn_ms;\r\n            settingsData.durationInMins = moment.duration(durationIn_ms).humanize();\r\n            settingsData.bought = data.reality_check.buy_count;\r\n            settingsData.turnOver = data.reality_check.buy_amount;\r\n            settingsData.loginTime = moment.utc(data.reality_check.start_time * 1000).format(\"MMM D, YYYY hh:mm\") + \" GMT\";\r\n            settingsData.sold = data.reality_check.sell_count;\r\n            settingsData.pnl = data.reality_check.sell_amount - data.reality_check.buy_amount;\r\n            settingsData.currentTime = moment.utc().format(\"MMM D, YYYY hh:mm\") + \" GMT\";\r\n            settingsData.open = data.reality_check.open_contract_count;\r\n            settingsData.potentialProfit = data.reality_check.potential_profit;\r\n            settingsData.currency = data.reality_check.currency;\r\n            resetWindow(false);\r\n            win.moveToTop();\r\n         });\r\n   }, logoutAfter_ms);\r\n};\r\n\r\nconst init = () => {\r\n   if (win) return Promise.resolve(true);\r\n\r\n   return new Promise((resolve) => {\r\n      liveapi\r\n         .cached\r\n         .authorize()\r\n         .then((data) => {\r\n            settingsData.loginId = data.authorize.loginid;\r\n            liveapi\r\n               .cached\r\n               .send({landing_company_details : data.authorize.landing_company_name})\r\n               .then((data) => {\r\n                  if (data && data.landing_company_details.has_reality_check) {\r\n\r\n                     require(['text!realitycheck/realitycheck.html', \"css!realitycheck/realitycheck.css\"], (html) => {\r\n                        const div = $(html).i18n();\r\n                        win = windows.createBlankWindow($('<div/>'), {\r\n                           title: 'Reality check'.i18n(),\r\n                           width: 600,\r\n                           minHeight: FIRST_SCREEN_HEIGHT,\r\n                           height: FIRST_SCREEN_HEIGHT,\r\n                           resizable: false,\r\n                           collapsable: false,\r\n                           minimizable: false,\r\n                           maximizable: false,\r\n                           closable: false,\r\n                           modal: true,\r\n                           closeOnEscape: false,\r\n                           ignoreTileAction:true,\r\n                           'data-authorized': 'true'\r\n                        });\r\n                        div.appendTo(win);\r\n\r\n                        //This helps in showing multiple dialog windows in modal form\r\n                        $('body').append(win.dialog('widget'));\r\n                        resetWindow(true);\r\n\r\n                        rv.bind(div[0], settingsData);\r\n\r\n                        resolve();\r\n                     });\r\n\r\n                  } else {\r\n                     local_storage.remove('realitycheck');\r\n                  }\r\n               });\r\n         })\r\n         .catch(\r\n            (err) => local_storage.remove('realitycheck')\r\n         );\r\n   });\r\n}\r\n\r\nconst logout = () => {\r\n   if (win) win.dialog('close');\r\n   if (timerHandler) clearTimeout(timerHandler);\r\n   timerHandler = null;\r\n   settingsData.timeOutInMins= 10;\r\n   settingsData.loginId= null;\r\n   settingsData.durationInMins= null;\r\n   settingsData.bought= null;\r\n   settingsData.turnOver= null;\r\n   settingsData.loginTime= null;\r\n   settingsData.sold= null;\r\n   settingsData.pnl= null;\r\n   settingsData.currentTime= null;\r\n   settingsData.open= null;\r\n   settingsData.potentialProfit= null;\r\n   settingsData.currency= null;\r\n};\r\n\r\nconst oauthLogin = () => {\r\n   logout();\r\n   if(!local_storage.get(\"authorize\").is_virtual){\r\n      const p = init();\r\n      promises.push(p);\r\n      Promise.all(promises).then(() => {\r\n         resetWindow(true);\r\n         win.dialog('open');\r\n         promises = [];\r\n      });\r\n   }\r\n\r\n};\r\n\r\nliveapi.events.on('oauth-login', oauthLogin);\r\nliveapi.events.on('login', (data) => {\r\n\r\n   if (settingsData.loginId != data.authorize.loginid) {\r\n      logout();\r\n   }\r\n\r\n   const realityCheck_fromStorage = local_storage.get(\"realitycheck\");\r\n   if (realityCheck_fromStorage && !local_storage.get(\"authorize\").is_virtual) {\r\n      const durationInMins = (moment.utc().valueOf() - (realityCheck_fromStorage.accepted_time)) / 60 / 1000;\r\n      init().then(() => {\r\n         const timeout = durationInMins >= realityCheck_fromStorage.timeOutInMins ? 0 :\r\n            Math.abs(realityCheck_fromStorage.timeOutInMins - durationInMins);\r\n         setOrRefreshTimer(timeout);\r\n      });\r\n   } else {\r\n      oauthLogin();\r\n   }\r\n\r\n});\r\n\r\nliveapi.events.on('reset_realitycheck', () => {\r\n   logout();\r\n   local_storage.remove('realitycheck');\r\n});\r\n\r\nliveapi.events.on('switch_account', () => {\r\n   local_storage.remove('realitycheck');\r\n   oauthLogin();\r\n});\r\n\r\nexport default {};\r\n\r\n"]}