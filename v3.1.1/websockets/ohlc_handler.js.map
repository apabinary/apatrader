{"version":3,"sources":["../../../../src/websockets/ohlc_handler.es6"],"names":["barsTable","processCandles","key","time","open","high","low","close","bar","chain","find","instrumentCdAndTp","limit","data","length","update","insert","events","on","echo_req","ticks_history","granularity","toUpperCase","candles","forEach","eachData","parseFloat","parseInt","epoch","barsLoaded","history","times","index","price","prices","retrieveChartDataAndRender","options","timePeriod","instrumentCode","containerIDWithHash","instrumentName","series_compare","keyFor","subscribe","Promise","resolve","done_promise","register","symbol","delayAmount","style","isTick","count","adjust_start_time","catch","err","msg","i18n","replace","require","$","growl","error","message","chart","highcharts","showLoading","console","then","warning","timerHandler","setInterval","lastBar","simplesort","requestObject","convertToTimeperiodObject","timeInSeconds","send","chartIDs","push"],"mappings":"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","file":"ohlc_handler.js","sourcesContent":["import liveapi from './binary_websockets';\r\nimport chartingRequestMap from '../charts/chartingRequestMap';\r\nimport $ from 'jquery';\r\nimport 'jquery-growl';\r\nimport 'common/util';\r\n\r\nconst barsTable = chartingRequestMap.barsTable;\r\n\r\nconst processCandles = (key, time, open, high, low, close) => {\r\n   let bar = barsTable.chain()\r\n      .find({time : time})\r\n      .find({instrumentCdAndTp : key})\r\n      .limit(1)\r\n      .data();\r\n   if (bar && bar.length > 0) {\r\n      bar = bar[0];\r\n      bar.open = open;\r\n      bar.high = high;\r\n      bar.low = low;\r\n      bar.close = close;\r\n      barsTable.update(bar);\r\n   } else {\r\n      barsTable.insert({\r\n         instrumentCdAndTp : key,\r\n         time: time,\r\n         open: open,\r\n         high: high,\r\n         low: low,\r\n         close: close\r\n      });\r\n   }\r\n};\r\n\r\nliveapi.events.on('candles', (data) => {\r\n   const key = (data.echo_req.ticks_history + data.echo_req.granularity).toUpperCase();\r\n   data.candles.forEach((eachData) => {\r\n      const open  = parseFloat(eachData.open),\r\n         high  = parseFloat(eachData.high),\r\n         low   = parseFloat(eachData.low),\r\n         close = parseFloat(eachData.close),\r\n         time  = parseInt(eachData.epoch) * 1000;\r\n      processCandles(key, time, open, high, low, close);\r\n   });\r\n   chartingRequestMap.barsLoaded(key);\r\n});\r\n\r\nliveapi.events.on('history', (data) => {\r\n   //For tick history handling\r\n   const key = (data.echo_req.ticks_history + '0').toUpperCase();\r\n   data.history.times.forEach((eachData,index) => {\r\n      const time = parseInt(eachData) * 1000,\r\n         price = parseFloat(data.history.prices[index]);\r\n      processCandles(key, time, price, price, price, price);    \r\n   });\r\n   chartingRequestMap.barsLoaded(key);\r\n});\r\n\r\n/**\r\n * @param timePeriod\r\n * @param instrumentCode\r\n * @param containerIDWithHash\r\n * @param instrumentName\r\n * @param series_compare\r\n */\r\nexport const retrieveChartDataAndRender = (options) => {\r\n   const timePeriod = options.timePeriod,\r\n      instrumentCode = options.instrumentCode,\r\n      containerIDWithHash = options.containerIDWithHash,\r\n      instrumentName = options.instrumentName,\r\n      series_compare = options.series_compare;\r\n\r\n   const key = chartingRequestMap.keyFor(instrumentCode, timePeriod);\r\n   if (chartingRequestMap[key]) {\r\n      /* Since streaming for this instrument+timePeriod has already been requested,\r\n                   we just take note of containerIDWithHash so that once the data is received, we will just\r\n                   call refresh for all registered charts */\r\n      chartingRequestMap.subscribe(key, {\r\n         containerIDWithHash : containerIDWithHash,\r\n         series_compare : series_compare,\r\n         instrumentCode : instrumentCode,\r\n         instrumentName : instrumentName\r\n      });\r\n      /* We still need to call refresh the chart with data we already received\r\n                   Use local caching to retrieve that data.*/\r\n      chartingRequestMap.barsLoaded(key);\r\n      return Promise.resolve();\r\n   }\r\n\r\n   const done_promise = chartingRequestMap.register({\r\n      symbol: instrumentCode,\r\n      granularity: timePeriod,\r\n      subscribe: options.delayAmount === 0 ? 1 : 0,\r\n      style: !isTick(timePeriod) ? 'candles' : 'ticks',\r\n      count: 1000,          //We are only going to request 1000 bars if possible\r\n      adjust_start_time: 1\r\n   })\r\n      .catch((err) => {\r\n         const msg = 'Error getting data for %1'.i18n().replace('%1', instrumentName);\r\n         require([\"jquery\", \"jquery-growl\"], ($) => $.growl.error({ message: msg }) );\r\n         const chart = $(containerIDWithHash).highcharts();\r\n         chart && chart.showLoading(msg);\r\n         console.error(err);\r\n      })\r\n      .then((data) => {\r\n         if (data && !data.error && options.delayAmount > 0) {\r\n            //start the timer\r\n            require([\"jquery-growl\"], () => $.growl.warning({\r\n               message: instrumentName + ' feed is delayed by '.i18n() +\r\n               options.delayAmount + ' minutes'.i18n()\r\n            })\r\n            );\r\n            chartingRequestMap[key].timerHandler = setInterval(() => {\r\n               let lastBar = barsTable.chain()\r\n                  .find({instrumentCdAndTp : key})\r\n                  .simplesort('time', true)\r\n                  .limit(1)\r\n                  .data();\r\n               if (lastBar && lastBar.length > 0) {\r\n                  lastBar = lastBar[0];\r\n                  //requests new bars\r\n                  //Send the WS request\r\n                  const requestObject = {\r\n                     \"ticks_history\": instrumentCode,\r\n                     \"end\": 'latest',\r\n                     //\"count\": count,\r\n                     \"start\": (lastBar.time/1000) | 0,\r\n                     \"granularity\":  convertToTimeperiodObject(timePeriod).timeInSeconds()\r\n                  };\r\n                  liveapi.send(requestObject);\r\n               }\r\n            }, 60*1000);\r\n         }\r\n      });\r\n\r\n   chartingRequestMap[key].chartIDs.push({\r\n      containerIDWithHash : containerIDWithHash,\r\n      series_compare : series_compare,\r\n      instrumentCode : instrumentCode,\r\n      instrumentName : instrumentName\r\n   });\r\n   return done_promise;\r\n}\r\n\r\nexport default {\r\n   retrieveChartDataAndRender,\r\n};\r\n"]}