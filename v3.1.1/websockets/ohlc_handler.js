define(["exports","./binary_websockets","../charts/chartingRequestMap","jquery","jquery-growl","common/util"],function(a,b,c,d){"use strict";function e(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.retrieveChartDataAndRender=void 0;var f=e(b),g=e(c),h=e(d),i=g["default"].barsTable,j=function(a,b,c,d,e,f){var g=i.chain().find({time:b}).find({instrumentCdAndTp:a}).limit(1).data();g&&g.length>0?(g=g[0],g.open=c,g.high=d,g.low=e,g.close=f,i.update(g)):i.insert({instrumentCdAndTp:a,time:b,open:c,high:d,low:e,close:f})};f["default"].events.on("candles",function(a){var b=(a.echo_req.ticks_history+a.echo_req.granularity).toUpperCase();a.candles.forEach(function(a){var c=parseFloat(a.open),d=parseFloat(a.high),e=parseFloat(a.low),f=parseFloat(a.close),g=1e3*parseInt(a.epoch);j(b,g,c,d,e,f)}),g["default"].barsLoaded(b)}),f["default"].events.on("history",function(a){var b=(a.echo_req.ticks_history+"0").toUpperCase();a.history.times.forEach(function(c,d){var e=1e3*parseInt(c),f=parseFloat(a.history.prices[d]);j(b,e,f,f,f,f)}),g["default"].barsLoaded(b)});var k=a.retrieveChartDataAndRender=function(a){var b=a.timePeriod,c=a.instrumentCode,d=a.containerIDWithHash,e=a.instrumentName,j=a.series_compare,k=g["default"].keyFor(c,b);if(g["default"][k])return g["default"].subscribe(k,{containerIDWithHash:d,series_compare:j,instrumentCode:c,instrumentName:e}),g["default"].barsLoaded(k),Promise.resolve();var l=g["default"].register({symbol:c,granularity:b,subscribe:0===a.delayAmount?1:0,style:isTick(b)?"ticks":"candles",count:1e3,adjust_start_time:1})["catch"](function(a){var b="Error getting data for %1".i18n().replace("%1",e);require(["jquery","jquery-growl"],function(a){return a.growl.error({message:b})});var c=h["default"](d).highcharts();c&&c.showLoading(b)}).then(function(d){d&&!d.error&&a.delayAmount>0&&(require(["jquery-growl"],function(){return h["default"].growl.warning({message:e+" feed is delayed by ".i18n()+a.delayAmount+" minutes".i18n()})}),g["default"][k].timerHandler=setInterval(function(){var a=i.chain().find({instrumentCdAndTp:k}).simplesort("time",!0).limit(1).data();if(a&&a.length>0){a=a[0];var d={ticks_history:c,end:"latest",start:a.time/1e3|0,granularity:convertToTimeperiodObject(b).timeInSeconds()};f["default"].send(d)}},6e4))});return g["default"][k].chartIDs.push({containerIDWithHash:d,series_compare:j,instrumentCode:c,instrumentName:e}),l};a["default"]={retrieveChartDataAndRender:k}});