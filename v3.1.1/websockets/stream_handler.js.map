{"version":3,"sources":["../../../../src/websockets/stream_handler.es6"],"names":["barsTable","setExtremePointsForXAxis","chart","startTime","endTime","xAxis","forEach","getExtremes","min","max","setExtremes","events","on","data","key","echo_req","ticks_history","granularity","toUpperCase","price","parseFloat","tick","quote","time","parseInt","epoch","chartingRequest","id","instrumentCdAndTp","open","high","low","close","insert","preTick","bars","chain","find","simplesort","limit","length","fire_event","chartIDs","chartID","containerIDWithHash","highcharts","series","get","addPoint","ohlc","symbol","document","trigger","open_time","timePeriod","bar","isNew","update","preOhlc","is_new","type","last","options","isDataTypeClosePriceOnly","y","callbacks","name","args","fns","cb","setTimeout","apply","undefined","push","off","index","indexOf","splice"],"mappings":"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","file":"stream_handler.js","sourcesContent":["import $ from 'jquery';\r\nimport liveapi from './binary_websockets';\r\nimport chartingRequestMap from '../charts/chartingRequestMap';\r\nimport 'common/util';\r\n\r\n\r\nconst barsTable = chartingRequestMap.barsTable;\r\n\r\nconst setExtremePointsForXAxis = (chart, startTime, endTime) => {\r\n   chart.xAxis.forEach((xAxis) => {\r\n      if (!startTime) startTime = xAxis.getExtremes().min;\r\n      if (!endTime) endTime = xAxis.getExtremes().max;\r\n      xAxis.setExtremes(startTime, endTime);\r\n   });\r\n}\r\n\r\nliveapi.events.on('tick', (data) => {\r\n   let key = data.echo_req.ticks_history + data.echo_req.granularity;\r\n   if (key && chartingRequestMap[key.toUpperCase()]) {\r\n      key = key.toUpperCase();\r\n\r\n      const price = parseFloat(data.tick.quote);\r\n      const time = parseInt(data.tick.epoch) * 1000;\r\n\r\n      const chartingRequest = chartingRequestMap[key];\r\n      const granularity = data.echo_req.granularity || 0;\r\n      chartingRequest.id = chartingRequest.id || data.tick.id;\r\n\r\n      if(granularity === 0) {\r\n         const tick = {\r\n            instrumentCdAndTp: key,\r\n            time: time,\r\n            open: price,\r\n            high: price,\r\n            low: price,\r\n            close: price,\r\n            /* this will be used from trade confirmation dialog */\r\n            price: data.tick.quote, /* we need the original value for tick trades */\r\n         }\r\n         barsTable.insert(tick);\r\n         /* notify subscribers */\r\n         let preTick = tick;\r\n         const bars = barsTable.chain()\r\n            .find({ instrumentCdAndTp: key })\r\n            .simplesort('time', true)\r\n            .limit(2).data();\r\n         if (bars.length > 1)\r\n            preTick = bars[1];\r\n         fire_event('tick', { tick: tick, key: key, preTick: preTick });\r\n\r\n         if (!(chartingRequest.chartIDs && chartingRequest.chartIDs.length > 0)) {\r\n            return;\r\n         }\r\n         //notify all registered charts\r\n         chartingRequest.chartIDs.forEach((chartID) => {\r\n            const chart = $(chartID.containerIDWithHash).highcharts();\r\n            if (!chart) return;\r\n\r\n            const series = chart.get(key);\r\n            if (!series) return;\r\n\r\n            series.addPoint([time, price]);\r\n            //setExtremePointsForXAxis(chart, time);\r\n\r\n         });\r\n\r\n      }\r\n\r\n   }\r\n});\r\n\r\nliveapi.events.on('ohlc', (data) => {\r\n   let key = data.ohlc.symbol + data.ohlc.granularity;\r\n   if (key && chartingRequestMap[key.toUpperCase()]) {\r\n      key = key.toUpperCase();\r\n      // TODO: 1-consume this notification 2-do not use global notifications, use a better approach.\r\n      $(document).trigger(\"feedTypeNotification\", [key, \"realtime-feed\"]);\r\n\r\n      const open = parseFloat(data.ohlc.open);\r\n      const high = parseFloat(data.ohlc.high);\r\n      const low = parseFloat(data.ohlc.low);\r\n      const close = parseFloat(data.ohlc.close);\r\n      const time = parseInt(data.ohlc.open_time) * 1000;\r\n\r\n      const chartingRequest = chartingRequestMap[key];\r\n      chartingRequest.id = chartingRequest.id || data.ohlc.id;\r\n      if (!(chartingRequest.chartIDs && chartingRequest.chartIDs.length > 0)) {\r\n         return;\r\n      }\r\n      const timePeriod = $(chartingRequest.chartIDs[0].containerIDWithHash).data('timePeriod');\r\n      if (!timePeriod) {\r\n         return;\r\n      }\r\n\r\n      let bar = barsTable.chain()\r\n         .find({ '$and': [{instrumentCdAndTp: key}, {time : time}] })\r\n         .simplesort(\"time\", true)\r\n         .limit(1)\r\n         .data();\r\n      let isNew = false;\r\n      if (!bar || bar.length <= 0) {\r\n         bar = {\r\n            instrumentCdAndTp: key,\r\n            time: time,\r\n            open: open,\r\n            high: high,\r\n            low: low,\r\n            close: close\r\n         };\r\n         barsTable.insert(bar);\r\n         isNew = true;\r\n      } else {\r\n         bar = bar[0];\r\n         bar.open = open;\r\n         bar.high = high;\r\n         bar.low = low;\r\n         bar.close = close;\r\n         barsTable.update(bar);\r\n      }\r\n\r\n      let preOhlc = bar;\r\n      const bars = barsTable.chain()\r\n         .find({ instrumentCdAndTp: key })\r\n         .simplesort('time', true)\r\n         .limit(2).data();\r\n      if (bars.length > 1) {\r\n         preOhlc = bars[1];\r\n      }\r\n      /* notify subscribers */\r\n      fire_event('ohlc', { ohlc: bar, is_new: isNew, key: key, preOhlc: preOhlc });\r\n\r\n      //notify all registered charts\r\n      chartingRequest.chartIDs.forEach((chartID) => {\r\n\r\n         const chart = $(chartID.containerIDWithHash).highcharts();\r\n         if (!chart) return;\r\n\r\n         const series = chart.get(key);\r\n         if (!series) return;\r\n\r\n         const type = $(chartID.containerIDWithHash).data('type');\r\n\r\n         const last = series.data[series.data.length - 1];\r\n         if (series.options.data.length != series.data.length) {\r\n            //TODO - This is an error situation\r\n            setExtremePointsForXAxis(chart, null, bar.time);\r\n            return;\r\n         }\r\n\r\n         if (type && isDataTypeClosePriceOnly(type)) {//Only update when its not in loading mode\r\n            if (isNew) {\r\n               series.addPoint([time, close], true, true, false);\r\n            } else {\r\n               last.update({\r\n                  y : close\r\n               });\r\n            }\r\n         } else {\r\n            if (isNew) {\r\n               series.addPoint([time, open, high, low, close], true, true, false);\r\n            } else {\r\n               last.update({\r\n                  open : open,\r\n                  high : high,\r\n                  low : low,\r\n                  close : close\r\n               });\r\n            }\r\n         }\r\n      });\r\n   }\r\n});\r\n\r\nconst callbacks = { };\r\n/* fire a custom event and call registered callbacks(api.events.on(name)) */\r\nconst fire_event = (name , ...args) => {\r\n   const fns = callbacks[name] || [];\r\n   fns.forEach(\r\n      (cb) => setTimeout( () => cb.apply(undefined, args), 0)\r\n   );\r\n};\r\n\r\nexport const events = {\r\n   on: (name, cb) => {\r\n      (callbacks[name] = callbacks[name] || []).push(cb);\r\n      return cb;\r\n   },\r\n   off: (name, cb) => {\r\n      if(callbacks[name]) {\r\n         const index = callbacks[name].indexOf(cb);\r\n         index !== -1 && callbacks[name].splice(index, 1);\r\n      }\r\n   }\r\n};\r\nexport default {\r\n   events\r\n};\r\n"]}