define(["exports","jquery","lodash","navigation/navigation","windows/tracker","jquery.dialogextend","modernizr","common/util","css!windows/windows.css"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.tile=a.event_off=a.event_on=a.makeSelectmenu=a.createBlankWindow=a.closeAll=a.fixFooterPosition=a.init=void 0;var g=f(b),h=f(c),i=(f(d),f(e)),j=null,k=0,l=null,m=null,n=function(a){a=g["default"].extend({width:350,height:400},a);var b=Math.floor(g["default"](window).height()/a.height)||1,c=Math.floor(g["default"](window).width()/a.width)||1;return isSmallView()&&(b=c=1),b*c>4&&(b=1,c=4),{rows:b,cols:c,total:b*c}},o=function(a){for(var b=void 0,c=void 0,d=a.length;d>0;)c=Math.floor(Math.random()*d),--d,b=a[d],a[d]=a[c],a[c]=b;return a},p={},q=function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];var e=p[a]||[];e.forEach(function(a){setTimeout(function(){a.apply(void 0,c)},0)})},r=function(){for(var a=g["default"](".webtrader-dialog").filter(function(a,b){var c=g["default"](b);return c.hasClass("ui-dialog-content")&&c.dialog("isOpen")&&!c.hasClass("ui-dialog-minimized")&&g["default"](window).width()>=c.dialog("option","width")}),b=function(a,b){for(var c=0,d=g["default"](window).width(),e=110,f=0;f<a.length;){for(var h=f,i=0,j=0;f!=a.length;){var k=g["default"](a[f]),l=k.dialog("option","width"),m=k.dialog("option","height");if(i=Math.max(i,m),!(d>=j+l))break;j+=l,++f}var n=d>j?d-j:0,o=d>j?(d-j)/(f-h+1):0;f!=a.length&&(c+=n),0===j&&g["default"](a[f]).dialog("option","width")>d&&(++f,o=0),j=0;for(var p=h;f>p;++p){j+=o;{var q=g["default"](a[p]),r=q.dialog("option","width");q.dialog("option","height")}b&&q.dialog("widget").animate({left:j+"px",top:e+"px"},1500,q.trigger.bind(q,"animated")),q.dialog("option","position",{my:j,at:e}),j+=r}e+=i+20}return b&&setTimeout(w,1600),c},c=null,d=1e6,e=0;100>e;++e){o(a);var f=b(a,!1);d>f&&(c=a.slice(),d=f)}var i=g["default"](".webtrader-dialog").filter(function(a,b){var c=g["default"](b);return c.hasClass("ui-dialog-content")&&c.dialog("isOpen")&&!c.hasClass("ui-dialog-minimized")&&g["default"](window).width()<c.dialog("option","width")});h["default"](i).forEach(function(a){c.push(a)}),b(c,!0),m=null,setTimeout(function(){return q("tile")},1600)},s=function(a){a=g["default"].extend({title:"title",date:null,changed:function(){},cleared:function(){}},a);var b=this.parent().find(".ui-dialog-title").addClass("with-content"),c=function(a){var c=function(a,b){var c=a%4==0&&(a%100!=0||a%400==0);return[31,c?29:28,31,30,31,30,31,31,30,31,30,31][b]},d=function(a,b){var c=b.render||function(a){return a+""};a.children().remove();for(var d=b.min;d<=b.max;++d)g["default"]("<option/>").val(d).text(c(d)).appendTo(a);return a.val(b.initial||b.min),a.selectmenu("refresh"),a.title=a.title||function(c){if(c)a._title=a._title||g["default"]("<option/>").val(-1).prependTo(a),a._title.text(c),a.updating=!0,a.val(-1).selectmenu("refresh"),a.updating=!1;else if(a._title){var d=-1===a.val()?b.initial:a.val();a._title.remove(),a.updating=!0,a.val(d).selectmenu("refresh"),a.updating=!1,this._title=null}},a},e=a.date||new Date,f=g["default"]("<select />").insertAfter(b).selectmenu({width:"auto"}),h=g["default"]("<select />").insertAfter(b).selectmenu({width:"auto"}),i=g["default"]("<select />").insertAfter(b).selectmenu({width:"auto"});i.selectmenu("menuWidget").addClass("date-day"),f=d(f,{min:2010,max:e.getFullYear(),initial:e.getFullYear()}),h=d(h,{min:0,max:11,initial:e.getMonth(),render:function(a){return["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"][a]}}),i=d(i,{min:1,max:c(e.getFullYear(),e.getMonth()),initial:e.getDate()}),a.date||(f.title("Year"),h.title("Month"),i.title("Day"));var j=function(){var b=new Date(Date.UTC(f.val(),h.val(),i.val())).toISOString().slice(0,10);a.onchange(b)};i.on("selectmenuchange",function(){i.updating||(i.title(null),h.title(null),f.title(null),j())});var k=function(){var a={min:1,max:c(f.val(),h.val()),initial:i.val()};a.initial>a.max&&(a.initial=a.min),d(i,a)};return[f,h].forEach(function(a){a.on("selectmenuchange",function(){h.updating||f.updating||(i.title(null),h.title(null),f.title(null),k(),j())})}),{update:function(a){i.title(null),h.title(null),f.title(null);var b=a.split("-");f.val(0|b[0]),f.selectmenu("refresh"),h.val((0|b[1])-1),h.selectmenu("refresh"),i.val(0|b[2]),k()},clear:function(){f.title("Year"),h.title("Month"),i.title("Day")}}},d=function(a){var c=g["default"]("<input type='hidden' />").insertAfter(b),d=function(b){setTimeout(function(){var c=g["default"](b).datepicker("widget").find(".ui-datepicker-buttonpane");g["default"]("<button/>",{text:"Clear".i18n(),click:function(){a.onclear&&a.onclear(),g["default"](b).datepicker("hide")}}).addClass("ui-datepicker-clear ui-state-default ui-priority-primary ui-corner-all").appendTo(c)},0)},e={showOn:"both",numberOfMonths:1,maxDate:0,minDate:new Date(2010,0,1),dateFormat:"yy-mm-dd",showAnim:"drop",showButtonPanel:!0,changeMonth:!0,changeYear:!0,onSelect:function(){g["default"](this).change()},beforeShow:function(a,b){d(a),b.dpDiv.css({marginTop:"10px",marginLeft:"-220px"})},onChangeMonthYear:d,closeText:"Done".i18n(),currentText:"Today".i18n()},f=c.datepicker(e).datepicker("setDate",a.date.toISOString().slice(0,10));return g["default"].datepicker._gotoToday=function(a){g["default"](a).datepicker("setDate",new Date).change().datepicker("hide")},f.next("button").text("").button({icons:{primary:"ui-icon-calendar"}}),c.on("change",function(){var b=g["default"](this).val();a.onchange&&a.onchange(b)}),c},e=d({date:a.date||new Date,onchange:function(b){f.update(b),a.changed(b)},onclear:function(){f.clear(),a.cleared()}}),f=c({date:a.date,onchange:function(b){e.datepicker("setDate",b),a.changed(b)}});return g["default"]('<span class="span-in-dialog-header">'+a.title+"</span>").insertAfter(b),{clear:function(){return f.clear()}}},t=function(a){var b=g["default"](".ui-dialog").map(function(a,b){var c=g["default"](b),d=c.find(".webtrader-dialog");if(d&&d.hasClass("ui-dialog-content")&&!d.hasClass("ui-dialog-minimized")){var e=c.offset();return e&&e.top+c.height()||0}return 0});return a||b.push(g["default"]("body").height()),Math.max.apply(null,b)},u=function(){var a=g["default"](".addiction-warning").height(),b=g["default"](document).height()-g["default"](window).height()-g["default"](window).scrollTop();g["default"]("#dialog-extend-fixed-container").css("bottom",Math.max(0,a-b))},v=a.init=function(a){var b=g["default"].fn.dialog;g["default"].fn.dialog=function(a){return"destroy"===a?(this.trigger("dialogdestroy"),b.call(this,"destroy")):b.apply(this,arguments)},l=a.find("ul");var c=l.find(".tile");return j=l.find(".closeAll"),j.click(function(){g["default"](".webtrader-dialog").length>0&&g["default"](".webtrader-dialog").dialog("close")}),c.click(r),require(["charts/chartWindow","websockets/binary_websockets","navigation/menu"],function(a,b,c){if(!i["default"].is_empty())return i["default"].reopen(),void setTimeout(w,200);var d=n();b.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(b){b=c.extractChartableMarkets(b);for(var e=function(a){return a[Math.floor(Math.random()*a.length)]},f=["2h","4h","8h","1d"],g=["candlestick","line","ohlc","spline"],h=0;h<d.total;++h){var i=e(b).submarkets,j=e(i).instruments,k=e(j),l=e(f),m=e(g);a.addNewWindow({instrumentCode:k.symbol,instrumentName:k.display_name,timePeriod:l,type:m,delayAmount:k.delay_amount})}r()})}),require(["websockets/binary_websockets"],function(a){if(local_storage.get("oauth")){var b=local_storage.get("oauth");Promise.all(b.slice(1).map(function(a){return{authorize:a.token}}).map(function(b){return a.send(b)})).then(function(c){return a.cached.authorize().then(function(a){c.unshift(a);for(var d=!1,e=0;e<c.length;++e)b[e].id=c[e].authorize.loginid,b[e].is_virtual=c[e].authorize.is_virtual,-1!==c[e].authorize.landing_company_name.indexOf("japan")&&(d=!0);return local_storage.set("oauth",b),d})}).then(function(b){b&&b===!0&&(a.invalidate(),g["default"].growl.error({message:"Japan accounts are not supported.".i18n(),duration:6e3}),local_storage.remove("oauth"),local_storage.remove("oauth-login"))})["catch"](function(c){return"SelfExclusion"===c.code?void b.forEach(function(b){return b.id.match(/^VRTC/)?void a.switch_account(b.id):void 0}):(g["default"].growl.error({message:c.message}),local_storage.remove("oauth"),void g["default"](".login").trigger("login-error"))})}}),g["default"](window).resize(w),g["default"](window).scroll(u),this},w=a.fixFooterPosition=function(a){g["default"]("body > .footer").width(g["default"]("body").width());var b=t(!0),c=g["default"]("body").height(),d=g["default"](".addiction-warning").height(),e=g["default"]("body > .footer").height(),f=Math.max(b+d+15,c);e>f&&a===!0||g["default"]("body > .footer").css("margin-top",f-100)},x=a.closeAll=function(){return j&&j.click()},y=a.createBlankWindow=function(a,b){a=g["default"](a);var c="windows-dialog-"+ ++k;b=g["default"].extend({autoOpen:!1,resizable:!0,collapsable:!1,width:350,height:400,my:"center",at:"center",of:window,title:"Blank window".i18n(),hide:"fade",icons:{close:"custom-icon-close",minimize:"custom-icon-minimize",maximize:"custom-icon-maximize"},open:function(){g["default"](this).promise().done(function(){var a=g["default"](this).dialog("option","isTrackerInitiated"),b=g["default"](this).dialog("option","relativePosition");if(!a&&b){if(!g["default"](m).parent().length)return void(m=g["default"](this));var c=parseInt(g["default"](m).parent().css("top")),d=parseInt(g["default"](m).parent().css("left"));g["default"](g["default"](this).parent()).css("top",c+5+"px"),g["default"](g["default"](this).parent()).css("left",d+5+"px"),m=g["default"](this)}})}},b||{}),b.minWidth=b.minWidth||b.width,b.minHeight=b.minHeight||b.height,b.resize&&(b.maximize=b.minimize=b.restore=b.resize);var d=a.attr("id",c);b.ignoreTileAction||d.addClass("webtrader-dialog"),d.dialog(b).dialogExtend(b);var e=d.dialog("widget");e.draggable("option","containment",!1),e.draggable("option","scroll",!0),e.on("dragstop",function(){var a=e.offset().top;0>a&&e.animate({top:"0px"},300,e.trigger.bind(e,"animated"))}),e.on("dragstop",w),e.on("drag",function(){return w(!0)}),d.on("dialogextendminimize",w),e.on("dialogresizestop",w),b.destroy&&d.on("dialogdestroy",b.destroy),d.moveToTop=function(){d.dialog("open"),d.dialogExtend("restore"),d.dialog("widget").effect("bounce",{times:2,distance:15},450)};var f=null,j=function(){var a=g["default"]("<a href='#'>"+b.title+"</a>");a.click(d.moveToTop),f=g["default"]("<li />").addClass(c+"LI").html(a),l.append(f)};b.ignoreTileAction||j(),d.on("dialogclose",function(){f&&f.remove(),f=null,w()}),d.on("dialogopen",function(){return!f&&!b.ignoreTileAction&&j()}),d.on("dialogextendrestore",w),b.resize&&b.resize.call(a[0]),d.addDateToHeader=s;var n=Object.keys(b).filter(function(a){return h["default"].startsWith(a,"data-")});if(n.forEach(function(a){return d.attr(a,b[a])}),b.refresh){var o=d.parent().find(".ui-dialog-title"),p=o.append("<img class='reload' src='images/refresh.svg' title='reload'/>").find(".reload");p.on("click",b.refresh)}return d.track=function(a){return i["default"].track(a,d)},d.fixFooterPosition=w,d.destroy=function(){return d.dialog("destroy").remove()},d},z=a.makeSelectmenu=function(a,b){b=g["default"].extend({list:["empty"],inx:0,changed:function(){}},b);var c=b.inx,d=b.list,e=function(b){a.children().remove();for(var c=0;c<b.length;++c)g["default"]("<option/>").val(b[c]).text(b[c]).appendTo(a)};return e(d),a.val(d[c]),a=a.selectmenu({width:b.width}),a.on("selectmenuchange",function(){var a=g["default"](this).val();b.changed(a)}),a.update_list=function(b){e(b),a.val(b[0]),a.selectmenu("refresh")},a},A=a.event_on=function(a,b){return(p[a]=p[a]||[]).push(b),b},B=a.event_off=function(a,b){if(p[a]){var c=p[a].indexOf(b);-1!==c&&p[a].splice(c,1)}},C=a.tile=r;a["default"]={init:v,tile:C,closeAll:x,fixFooterPosition:w,createBlankWindow:y,makeSelectmenu:z,event_on:A,event_off:B}});