{"version":3,"sources":["../../../../src/token/token.es6"],"names":["token_win","token_win_view","binders","routine","el","text","clip","trigger","on","$","growl","notice","message","error","i18n","_rv_clipboard_","destroy","unbind","init_state","root","state","route","search_input","tokens","token","name","scopes","read","trade","payments","admin","btn_disabled","checkTokenName","e","scope","token_name","length","substr","match","replace","test","confirm","visible","top","tokens_filtered","txt","toLowerCase","filter","display_name","indexOf","permissions","show","span","target","position","parent","height","attr","no","yes","send","api_token","delete_token","then","data","update_tokens","catch","err","change_route","forEach","join","last_used_tooltip","last_used","utc","fromNow","add","request","new_token","new_token_scopes","push","error_msg","console","bind","initTokenWin","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","minHeight","close","track","module_id","is_unique","dialog","init","$menuLink","click","moveToTop"],"mappings":"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","file":"token.js","sourcesContent":["/* created by apoorv, on Jan 31 2017 */\r\nimport liveapi from 'websockets/binary_websockets';\r\nimport windows from 'windows/windows';\r\nimport rv from 'common/rivetsExtra';\r\nimport moment from 'moment';\r\nimport clipboard from 'clipboard';\r\nimport html from 'text!token/token.html';\r\nimport {find} from 'lodash';\r\nimport 'css!token/token.css';\r\n\r\nlet token_win = null;\r\nlet token_win_view = null;\r\n\r\n/* rivetjs clipboard copy binder */\r\nrv.binders['clipboard'] = {\r\n    routine: (el, text) => {\r\n        const clip = new clipboard(el, {\r\n            text: (trigger) => {\r\n                return text;\r\n            }\r\n        });\r\n\r\n        clip.on('success', () => {\r\n            $.growl.notice({ message: 'Copied \"' + text + '\"' });\r\n        });\r\n\r\n        clip.on('error', () => {\r\n            $.growl.error({ message: 'Your browser doesn\\'t support copy to clipboard'.i18n() });\r\n        });\r\n\r\n        el._rv_clipboard_ && el._rv_clipboard_.destroy();\r\n        el._rv_clipboard_ = clip;\r\n    },\r\n    unbind: (el) => {\r\n        el._rv_clipboard_.destroy();\r\n    }\r\n};\r\n\r\nconst init_state = (root) => {\r\n    const state = {\r\n        route: 'token-list',\r\n        search_input: '',\r\n        tokens: [],\r\n        token: {\r\n            name: '',\r\n            scopes: {\r\n                read: true,\r\n                trade: false,\r\n                payments: false,\r\n                admin: false\r\n            },\r\n            btn_disabled: false,\r\n            checkTokenName: (e,scope) => {\r\n              let token_name = scope.token.name;\r\n              if(token_name.length > 32){\r\n                $.growl.error({message:\"Token name can have a maximum of 32 characters\".i18n()});\r\n                scope.token.name = token_name.substr(0,32);\r\n              }\r\n              if(token_name.match(/[^\\w\\s]+/g) != null){\r\n                $.growl.error({message:\"Token name can contain alphanumeric characters with spaces and underscores\".i18n()});\r\n                scope.token.name = token_name.replace(/[^\\w\\s]+/g, \"\");\r\n              }\r\n              if(!/^[\\w]/.test(token_name)){\r\n                $.growl.error({message:\"Token name should begin with alphanumeric characters only\".i18n()});\r\n                scope.token.name = token_name.replace(/^[^\\w]+/g, \"\");\r\n              }\r\n            }\r\n        },\r\n        confirm: {\r\n            visible: false,\r\n            top: '0px',\r\n            token: {}\r\n        }\r\n    };\r\n\r\n    state.tokens_filtered = () => {\r\n        const txt = state.search_input.toLowerCase();\r\n        return state.tokens.filter((token) => {\r\n            return txt === '' || token.display_name.toLowerCase().indexOf(txt) !== -1 || token.token.toLowerCase().indexOf(txt) !== -1 || token.permissions.toLowerCase().indexOf(txt) !== -1;\r\n        });\r\n    }\r\n\r\n    state.confirm.show = (e) => {\r\n        const span = $(e.target);\r\n        const top = span.position().top - span.parent().parent().height();\r\n        let token = span.attr('token-id');\r\n        token = find(state.tokens, { token: token });\r\n        state.confirm.top = top + 'px';\r\n        state.confirm.visible = true;\r\n        state.confirm.token = token;\r\n\r\n    }\r\n    state.confirm.no = () => {\r\n        state.confirm.visible = false;\r\n    }\r\n    state.confirm.yes = () => {\r\n        const token = state.confirm.token;\r\n        state.confirm.visible = false;\r\n        liveapi.send({ api_token: 1, delete_token: token.token })\r\n            .then((data) => {\r\n                const tokens = (data.api_token && data.api_token.tokens) || [];\r\n                state.update_tokens(tokens);\r\n            })\r\n            .catch((err) => {\r\n                $.growl.error({ message: err.message });\r\n            });\r\n    }\r\n\r\n    state.change_route = (route) => {\r\n        if (route !== 'token-list')\r\n            state.confirm.visible = false;\r\n        state.route = route;\r\n    }\r\n    state.update_tokens = (tokens) => {\r\n        tokens.forEach((token) => {\r\n            const scopes = token.scopes;\r\n            token.permissions = scopes.length == 4 ? 'All' : scopes.join(', ');\r\n\r\n            token.last_used_tooltip = token.last_used;\r\n            token.last_used = token.last_used ? moment.utc(token.last_used, 'YYYY-MM-DD HH:mm:ss').fromNow() : '-';\r\n        });\r\n        state.tokens = tokens;\r\n    }\r\n\r\n    state.token.add = () => {\r\n        if(state.token.name.length < 2){\r\n          $.growl.error({message:\"Token name must contain atleast 2 characters\".i18n()});\r\n          return;\r\n        }\r\n\r\n        const request = {\r\n            api_token: 1,\r\n            new_token: state.token.name,\r\n            new_token_scopes: []\r\n        };\r\n\r\n        state.token.scopes.read && request.new_token_scopes.push('read');\r\n        state.token.scopes.trade && request.new_token_scopes.push('trade');\r\n        state.token.scopes.payments && request.new_token_scopes.push('payments');\r\n        state.token.scopes.admin && request.new_token_scopes.push('admin');\r\n\r\n        let error_msg = '';\r\n\r\n        if (!request.new_token_scopes.length)\r\n            error_msg = 'Please choose at least one token scope'.i18n();\r\n        if (!request.new_token || !request.new_token.length)\r\n            error_msg = 'Please enter the token name'.i18n();\r\n\r\n        if (error_msg) {\r\n            $.growl.error({ message: error_msg });\r\n            return;\r\n        }\r\n\r\n        state.token.btn_disabled = true;\r\n        liveapi.send(request).then((data) => {\r\n            state.token.name = '';\r\n            state.token.btn_disabled = false;\r\n            $.growl.notice({ message: 'Successfully added new token \"'.i18n() + request.new_token + '\"' });\r\n\r\n            const tokens = (data.api_token && data.api_token.tokens) || [];\r\n            state.update_tokens(tokens);\r\n\r\n            state.change_route('token-list');\r\n        }).catch((err) => {\r\n            state.token.btn_disabled = false;\r\n            $.growl.error({ message: err.message });\r\n            console.error(err);\r\n        });\r\n\r\n    }\r\n\r\n    token_win_view = rv.bind(root[0], state);\r\n    return liveapi.send({ api_token: 1 })\r\n        .then((data) => {\r\n            const tokens = (data.api_token && data.api_token.tokens) || [];\r\n            state.update_tokens(tokens);\r\n        })\r\n        .catch((err) => {\r\n            $.growl.error({ message: err.message });\r\n            console.error(err);\r\n        });\r\n}\r\n\r\nconst initTokenWin = (root) => {\r\n    root = $(root).i18n();\r\n    token_win = windows.createBlankWindow(root, {\r\n        title: 'Token management'.i18n(),\r\n        resizable: false,\r\n        collapsable: false,\r\n        minimizable: true,\r\n        maximizable: false,\r\n        width: 700,\r\n        minHeight: 60,\r\n        'data-authorized': true,\r\n        close: () => {\r\n            token_win_view && token_win_view.unbind();\r\n            token_win_view = null;\r\n            token_win.destroy();\r\n            token_win = null;\r\n        }\r\n    });\r\n    token_win.track({\r\n        module_id: 'token',\r\n        is_unique: true,\r\n        data: null\r\n    });\r\n    init_state(root).then(() => {\r\n        token_win.dialog('open');\r\n    })\r\n}\r\n\r\nexport const init = ($menuLink) => {\r\n    $menuLink.click(() => {\r\n        if (!token_win)\r\n            initTokenWin(html);\r\n        else\r\n            token_win.moveToTop();\r\n    });\r\n}\r\n\r\nexport default {\r\n    init\r\n}\r\n"]}