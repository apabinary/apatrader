{"version":3,"sources":["../../../../src/viewtransaction/viewTransaction.es6"],"names":["open_dialogs","require","market_data_disruption_win","show_market_data_disruption_win","proposal","moveToTop","msg","i18n","root","createBlankWindow","title","height","resizable","collapsable","minimizable","maximizable","destroy","dialog","remove","window","dd","init_chart","state","options","data","type","decimal_digits","history","times","prices","i","length","push","Math","max","substring","indexOf","candles","map","c","epoch","open","high","low","close","el","find","chart_options","credits","href","text","chart","renderTo","backgroundColor","width","marginLeft","marginRight","events","load","element","onclick","style","fontSize","tooltip","xDateFormat","valueDecimals","undefined","xAxis","categories","startOnTick","endOnTick","min","first","last","labels","overflow","format","yAxis","align","x","y","series","name","exporting","enabled","enableImages","legend","navigator","plotOptions","line","marker","radius","candlestick","lineColor","color","upColor","upLineColor","shadow","rangeSelector","Highcharts","Chart","addPlotLineX","addPlotLine","value","id","label","text_left","zIndex","addPlotLineY","get_tick_value","symbol","send","ticks_history","granularity","start","end","count","catch","err","console","error","init","contract_id","transaction_id","Promise","resolve","reject","proposal_open_contract","then","underlying","longcode","init_dialog","growl","message","update_indicative","contract","bid_price","validation_error","validation","is_expired","is_valid_to_sell","is_forward_starting","date_start","current_spot_time","fwd_starting","table","date_expiry","current_spot","sell","bid_prices","shift","unit","split","cent","manual_reflow","contract_type","profit","buy_price","profit_point","per_point","entry_tick","direction","is_sold","status","exit_tick","exit_tick_time","sell_timeS","sell_price","final_price","barrier","high_barrier","low_barrier","html","init_state","on_proposal_open_contract","transWin","display_name","minWidth","minHeight","view","unbind","forget","off","onclose","subscribe","on","resize","bind","sell_at_market","sell_at_market_enabled","price","state_confirm","sold_for","return_percent","toFixed","balance","balance_after","currency","$html","after","view_confirm","route","update","is_settleable","is_ended","user_sold","sell_time","entry_spot","entry_tick_time","formatPrice","tick_count","prediction","sell_spot_time","sell_spot","purchase_time","is_sold_at_market","loading","shortcode","toUpperCase","details","replace","stop_loss","stop_profit","is_point","is_up","amount_per_point","parseFloat","pro_los","request","toLowerCase","h","container","transactionChart","setSize","hasUserSize","showLoading","hideLoading","get_chart_data","on_till","transaction","action","_data","update_live_chart","key","keyFor","req","register","on_tick","on_candles","perv_tick","tick","addPoint","quote","clean_up","data_key","ohlc","open_time","clean_up_done","unregister","duration","utc","unix","margin","filter","t","p","inx","spread","decPlaces","exec","stop_loss_level","stop_profit_level"],"mappings":"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","file":"viewTransaction.js","sourcesContent":["﻿/**\r\n * Created by amin on January 14, 2016.\r\n */\r\n\r\nimport $ from 'jquery';\r\nimport windows from 'windows/windows';\r\nimport liveapi from 'websockets/binary_websockets';\r\nimport chartingRequestMap from 'charts/chartingRequestMap';\r\nimport rv from 'common/rivetsExtra';\r\nimport moment from 'moment';\r\nimport _ from 'lodash';\r\nimport 'jquery-growl';\r\nimport 'common/util';\r\n\r\nconst open_dialogs = {};\r\n\r\nrequire(['css!viewtransaction/viewTransaction.css']);\r\nrequire(['text!viewtransaction/viewTransaction.html']);\r\n\r\nlet market_data_disruption_win = null;\r\nconst show_market_data_disruption_win = (proposal) => {\r\n   if(market_data_disruption_win){\r\n      market_data_disruption_win.moveToTop();\r\n      return;\r\n   }\r\n   const msg = 'There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.'.i18n();\r\n   // const msg = proposal.validation_error;\r\n   const root = $('<div class=\"data-disruption-dialog\">' + msg + '</div>');\r\n\r\n   market_data_disruption_win = windows.createBlankWindow(root, {\r\n      title: ' There was an error '.i18n(),\r\n      height: 200,\r\n      resizable:false,\r\n      collapsable:false,\r\n      minimizable: false,\r\n      maximizable: false,\r\n      destroy: () => {\r\n         market_data_disruption_win && market_data_disruption_win.dialog('destroy').remove();\r\n         market_data_disruption_win = null;\r\n      },\r\n      'data-authorized': 'true'\r\n   });\r\n\r\n   market_data_disruption_win.dialog('open');\r\n   window.dd = market_data_disruption_win;\r\n}\r\n\r\nconst init_chart = (root, state, options) => {\r\n   let data = [];\r\n   let type = '';\r\n   let decimal_digits = 0;\r\n   if(options.history){\r\n      type = 'line';\r\n      const history = options.history;\r\n      const times = history.times;\r\n      const prices = history.prices;\r\n      for(let i = 0; i < times.length; ++i) {\r\n         data.push([times[i]*1000, prices[i]*1]);\r\n         decimal_digits = Math.max(decimal_digits, prices[i].substring(prices[i].indexOf('.') + 1).length);\r\n      }\r\n   }\r\n   if(options.candles) {\r\n      type = 'candlestick';\r\n      data = options.candles.map(\r\n         (c) => [c.epoch*1000, c.open*1, c.high*1, c.low*1, c.close*1]\r\n      )\r\n   }\r\n   const title = options.title;\r\n   const el = root.find('.transaction-chart')[0];\r\n\r\n   const chart_options = {\r\n      credits: { href: 'https://www.binary.com', text: 'Binary.com' },\r\n      chart: {\r\n         type: 'line',\r\n         renderTo: el,\r\n         backgroundColor: null, /* make background transparent */\r\n         width: 0,\r\n         height: 0,\r\n         marginLeft:20,\r\n         marginRight:20,\r\n         events: {\r\n            load: function() {\r\n               this.credits.element.onclick = () => window.open( 'https://www.binary.com', '_blank' );\r\n            }\r\n         }\r\n      },\r\n      title:{\r\n         text: title,\r\n         style: { fontSize:'16px' }\r\n      },\r\n      tooltip:{\r\n         xDateFormat:'%A, %b %e, %H:%M:%S GMT',\r\n         valueDecimals: decimal_digits || undefined,\r\n      },\r\n      xAxis: {\r\n         type: 'datetime',\r\n         categories:null,\r\n         startOnTick: false,\r\n         endOnTick: false,\r\n         min: data.length ? _.first(data)[0] : null,\r\n         max: data.length ? _.last(data)[0] : null,\r\n         labels: { overflow:\"justify\", format:\"{value:%H:%M:%S}\" },\r\n      },\r\n      yAxis: {\r\n         labels: { align: 'left', x: 0, y: -2 },\r\n         title: '',\r\n         // gridLineWidth: 0,\r\n      },\r\n      series: [{\r\n         name: title,\r\n         data: data,\r\n         type: type\r\n      }],\r\n      exporting: {enabled: false, enableImages: false},\r\n      legend: {enabled: false},\r\n      navigator: { enabled: true },\r\n      plotOptions: {\r\n         line: {\r\n            marker: { radius: 2 }\r\n         },\r\n         candlestick: {\r\n            lineColor: 'black',\r\n            color: 'red',\r\n            upColor: 'green',\r\n            upLineColor: 'black',\r\n            shadow: true\r\n         },\r\n      },\r\n      rangeSelector: { enabled: false },\r\n   };\r\n   const chart = new Highcharts.Chart(chart_options);\r\n\r\n   chart.addPlotLineX = (options) => {\r\n      chart.xAxis[0].addPlotLine({\r\n         value: options.value,\r\n         id: options.id || options.value,\r\n         label: {text: options.label || 'label', x: options.text_left ? -15 : 5},\r\n         color: options.color || '#e98024',\r\n         zIndex: 4,\r\n         width: options.width || 2,\r\n      });\r\n   };\r\n\r\n   chart.addPlotLineY = (options) => {\r\n      chart.yAxis[0].addPlotLine({\r\n         id: options.id || options.label,\r\n         value: options.value,\r\n         label: {text: options.label, align: 'center'},\r\n         color: options.color || 'green',\r\n         zIndex: 4,\r\n         width: 2,\r\n      });\r\n   };\r\n   return el.chart = chart;\r\n};\r\n\r\n/* get the tick value for a given epoch */\r\nconst get_tick_value = (symbol, epoch) => {\r\n   return liveapi.send({ticks_history: symbol, granularity: 0, style:'ticks', start: epoch, end:epoch+2, count: 1})\r\n      .catch((err) => console.error(err));\r\n}\r\n\r\nexport const init = (contract_id, transaction_id) => {\r\n   return new Promise((resolve, reject) => {\r\n      if(open_dialogs[transaction_id]) {\r\n         open_dialogs[transaction_id].moveToTop();\r\n         resolve();\r\n         return;\r\n      }\r\n      liveapi.send({proposal_open_contract: 1, contract_id: contract_id})\r\n         .then((data) => {\r\n            const proposal = data.proposal_open_contract;\r\n            /* check for market data disruption error */\r\n            if(proposal.underlying === undefined && proposal.longcode === undefined) {\r\n               show_market_data_disruption_win(proposal);\r\n               return;\r\n            }\r\n            proposal.transaction_id = transaction_id;\r\n            proposal.symbol = proposal.underlying;\r\n            init_dialog(proposal);\r\n            resolve();\r\n         })\r\n         .catch((err) => {\r\n            console.error(err);\r\n            $.growl.error({ message: err.message });\r\n            reject();\r\n         });\r\n   });\r\n}\r\n\r\nconst update_indicative = (data, state) => {\r\n   const contract = data.proposal_open_contract;\r\n   const id = contract.contract_id,\r\n      bid_price = contract.bid_price;\r\n   if(id != state.contract_id) { return; }\r\n   if(contract.validation_error)\r\n      state.validation = contract.validation_error;\r\n   else if(contract.is_expired)\r\n      state.validation = 'This contract has expired'.i18n();\r\n   else if(contract.is_valid_to_sell)\r\n      state.validation = 'Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.'.i18n();\r\n   if(contract.is_forward_starting && contract.date_start*1 > contract.current_spot_time*1)\r\n      state.fwd_starting = '* Contract is not yet started.'.i18n();\r\n   else\r\n      state.fwd_starting = '';\r\n   /*Do not update the current_spot and current_spot_time if the contract has expired*/\r\n   if(state.table.date_expiry*1 >= contract.current_spot_time*1) {\r\n      state.table.current_spot = contract.current_spot;\r\n      state.table.current_spot_time = contract.current_spot_time;\r\n      state.table.bid_price = contract.bid_price;\r\n      if(state.sell.bid_prices.length > 40) {\r\n         state.sell.bid_prices.shift();\r\n      }\r\n      state.sell.bid_prices.push(contract.bid_price)\r\n\r\n      if(contract.bid_price !== undefined) {\r\n         state.sell.bid_price.value = contract.bid_price;\r\n         state.sell.bid_price.unit = contract.bid_price.split(/[\\.,]+/)[0];\r\n         state.sell.bid_price.cent = contract.bid_price.split(/[\\.,]+/)[1];\r\n      }\r\n      state.sell.is_valid_to_sell = false;\r\n      state.sell.is_valid_to_sell = contract.is_valid_to_sell;\r\n      state.chart.manual_reflow();\r\n   } else {\r\n      /*Just change the current_spot_time to date_expiry*/\r\n      state.table.current_spot_time = state.table.date_expiry;\r\n   }\r\n   /*Required for spreads only*/\r\n   if(state.table.contract_type === \"SPREAD\"){\r\n      state.table.profit = contract.bid_price - contract.buy_price;\r\n      state.table.profit_point = state.table.profit / state.table.per_point;\r\n      if(state.table.entry_tick)\r\n         state.table.current_spot = state.table.entry_tick + state.table.profit_point * state.table.direction;\r\n      if(contract.is_sold){\r\n         state.table.status = \"Closed\";\r\n         state.table.is_sold = contract.is_sold;\r\n         state.table.exit_tick = state.table.entry_tick + state.table.profit_point * state.table.direction;\r\n         state.table.exit_tick_time = contract.sell_timeS;\r\n      }\r\n   }\r\n\r\n   if(contract.is_sold){\r\n      state.table.exit_tick = contract.exit_tick;\r\n      state.table.exit_tick_time = contract.exit_tick_time;\r\n      state.table.sell_price = contract.sell_price;\r\n      state.table.final_price = contract.sell_price;\r\n   }\r\n\r\n   if(!state.chart.barrier && contract.barrier) {\r\n      state.chart.barrier = contract.barrier;\r\n      state.chart.barrier && state.chart.chart.addPlotLineY({value: state.chart.barrier*1, label: 'Barrier ('.i18n() + state.chart.barrier + ')'});\r\n   }\r\n   if(!state.chart.high_barrier && contract.high_barrier) {\r\n      state.chart.high_barrier = contract.high_barrier;\r\n      state.chart.high_barrier && state.chart.chart.addPlotLineY({value: state.chart.high_barrier*1, label: 'High Barrier ('.i18n() + state.chart.high_barrier + ')'});\r\n   }\r\n   if(!state.chart.low_barrier && contract.low_barrier) {\r\n      state.chart.low_barrier = contract.low_barrier;\r\n      state.chart.low_barrier && state.chart.chart.addPlotLineY({value: state.chart.low_barrier*1, label: 'Low Barrier ('.i18n() + state.chart.low_barrier + ')', color: 'red'});\r\n   }\r\n}\r\n\r\nconst init_dialog = (proposal) => {\r\n   require(['text!viewtransaction/viewTransaction.html'],(html) => {\r\n      const root = $(html).i18n();\r\n      const state = init_state(proposal, root);\r\n      const on_proposal_open_contract = (data) => update_indicative(data, state);\r\n\r\n      const transWin = windows.createBlankWindow(root, {\r\n         title: proposal.display_name + ' (' + proposal.transaction_id + ')',\r\n         width: 700,\r\n         minWidth: 490,\r\n         minHeight:480,\r\n         height:480,\r\n         destroy: () => { },\r\n         close: function() {\r\n            view && view.unbind();\r\n            liveapi.proposal_open_contract.forget(proposal.contract_id);\r\n            liveapi.events.off('proposal_open_contract', on_proposal_open_contract);\r\n            for(let i = 0; i < state.onclose.length; ++i)\r\n               state.onclose[i]();\r\n            $(this).dialog('destroy').remove();\r\n            open_dialogs[proposal.transaction_id] = undefined;\r\n         },\r\n         open: () => {\r\n            liveapi.proposal_open_contract.subscribe(proposal.contract_id);\r\n            liveapi.events.on('proposal_open_contract', on_proposal_open_contract);\r\n         },\r\n         resize: () => {\r\n            state.chart.manual_reflow();\r\n            // state.chart.chart && state.chart.chart.reflow();\r\n         },\r\n         'data-authorized': 'true'\r\n      });\r\n\r\n      transWin.dialog('open');\r\n      const view = rv.bind(root[0],state)\r\n      open_dialogs[proposal.transaction_id] = transWin;\r\n   });\r\n}\r\n\r\nconst sell_at_market = (state, root) => {\r\n   state.sell.sell_at_market_enabled = false; /* disable button */\r\n   require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css']);\r\n   liveapi.send({sell: state.contract_id, price: 0 /* to sell at market */})\r\n      .then((data) => {\r\n         const sell = data.sell;\r\n         require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css'],\r\n            (html) => {\r\n               const buy_price = state.table.buy_price;\r\n               const state_confirm = {\r\n                  longcode: state.longcode,\r\n                  buy_price: buy_price,\r\n                  sell_price: sell.sold_for,\r\n                  return_percent: (100*(sell.sold_for - buy_price)/buy_price).toFixed(2)+'%',\r\n                  transaction_id: sell.transaction_id,\r\n                  balance: sell.balance_after,\r\n                  currency: state.table.currency,\r\n               };\r\n               const $html = $(html).i18n();\r\n               root.after($html);\r\n               const view_confirm = rv.bind($html[0], state_confirm);\r\n               state.onclose.push(() => {\r\n                  view_confirm && view_confirm.unbind();\r\n               });\r\n            });\r\n      })\r\n      .catch((err) => {\r\n         $.growl.error({ message: err.message });\r\n         console.error(err);\r\n      });\r\n}\r\n\r\nconst init_state = (proposal, root) =>{\r\n   const state = {\r\n      route: {\r\n         value: 'table',\r\n         update:(value) => { state.route.value = value; }\r\n      },\r\n      contract_id: proposal.contract_id,\r\n      longcode: proposal.longcode,\r\n      validation: proposal.validation_error\r\n      || (!proposal.is_valid_to_sell && 'Resale of this contract is not offered'.i18n())\r\n      || ((proposal.is_settleable || proposal.is_sold) && 'This contract has expired'.i18n()) || '-',\r\n      table: {\r\n         is_ended: proposal.is_settleable || proposal.is_sold,\r\n         currency: (proposal.currency ||  'USD') + ' ',\r\n         current_spot_time: proposal.current_spot_time,\r\n         current_spot: proposal.current_spot,\r\n         contract_type: proposal.contract_type,\r\n         date_start: proposal.date_start,\r\n         date_expiry: proposal.date_expiry,\r\n         user_sold: proposal.sell_time && proposal.sell_time < proposal.date_expiry,\r\n\r\n         entry_tick: proposal.entry_tick || proposal.entry_spot,\r\n         entry_tick_time: proposal.entry_tick_time,\r\n         exit_tick: proposal.exit_tick,\r\n         exit_tick_time: proposal.exit_tick_time,\r\n\r\n         buy_price: proposal.buy_price,\r\n         bid_price: undefined,\r\n         final_price: proposal.is_sold ? proposal.sell_price && formatPrice(proposal.sell_price) : undefined,\r\n\r\n         tick_count: proposal.tick_count,\r\n         prediction: proposal.prediction,\r\n\r\n         sell_time: proposal.sell_spot_time * 1 || undefined,\r\n         sell_spot: proposal.sell_spot,\r\n         sell_price: proposal.is_sold ? proposal.sell_price : undefined,\r\n         purchase_time: proposal.purchase_time,\r\n         is_sold_at_market: false,\r\n      },\r\n      chart: {\r\n         chart: null, /* highchart object */\r\n         symbol: proposal.symbol,\r\n         display_name: proposal.display_name,\r\n         barrier: proposal.barrier,\r\n         high_barrier: proposal.high_barrier,\r\n         low_barrier: proposal.low_barrier,\r\n         loading: 'Loading ' + proposal.display_name + ' ...',\r\n         type: 'ticks', // could be 'tick' or 'ohlc'\r\n      },\r\n      sell: {\r\n         bid_prices: [],\r\n         bid_price: {\r\n            unit: undefined,\r\n            cent: undefined,\r\n            value: undefined,\r\n         },\r\n         sell_at_market_enabled: true,\r\n         is_valid_to_sell: false,\r\n      },\r\n      onclose: [], /* cleanup callback array when dialog is closed */\r\n   };\r\n\r\n   // This values are required for SPREADS type contract.\r\n   if(proposal.contract_type.indexOf(\"SPREAD\") === 0){\r\n      const shortcode = proposal.shortcode.toUpperCase();\r\n      const details   = shortcode.replace(proposal.underlying.toUpperCase() + '_', '').split('_');\r\n      state.table.contract_type = \"SPREAD\";\r\n      state.table.status = proposal.is_sold? \"Closed\": \"Open\";\r\n      state.table.per_point = details[1];\r\n      state.table.stop_loss = details[3];\r\n      state.table.stop_profit = details[4];\r\n      state.table.is_point = details[5] === 'POINT';\r\n      state.table.is_up = proposal.shortcode['spread'.length] === 'U';\r\n      state.table.direction = state.table.is_up ? 1 : -1;\r\n      state.table.amount_per_point = state.table.is_up? \"+\" + state.table.per_point : \"-\" + state.table.per_point;\r\n      state.table.is_sold = proposal.is_sold;\r\n      state.table.exit_tick_time = state.table.is_sold ? proposal.sell_time : undefined;\r\n      state.table.profit = parseFloat(proposal.sell_price ? proposal.sell_price : proposal.bid_price) - parseFloat(proposal.buy_price);\r\n      state.table.profit_point = state.table.profit / state.table.per_point;\r\n      state.table.pro_los = \"Profit/Loss (\" + state.table.currency.replace(\" \",\"\") + \")\";\r\n      state.table.request ={\r\n         \"proposal\"        : 1,\r\n         \"symbol\"          : proposal.underlying,\r\n         \"currency\"        : proposal.currency,\r\n         \"contract_type\"   : details[0],\r\n         \"amount_per_point\": state.table.per_point,\r\n         \"stop_loss\"       : state.table.stop_loss,\r\n         \"stop_profit\"     : state.table.stop_profit,\r\n         \"stop_type\"       : details[5].toLowerCase()\r\n      };\r\n   }\r\n\r\n   state.sell.sell = () => sell_at_market(state, root);\r\n\r\n   state.chart.manual_reflow = () => {\r\n      /* TODO: find a better solution for resizing the chart  :/ */\r\n      const h = -1 * (root.find('.longcode').height() + root.find('.tabs').height() + root.find('.footer').height()) - 16;\r\n      if(!state.chart.chart) return;\r\n      const container = root;// root.find('.chart-container');\r\n      const transactionChart = container.find(\".transaction-chart\");\r\n      const width = container.width() - 10,\r\n         height = container.height();\r\n      state.chart.chart.setSize(width, height + h , false);\r\n      state.chart.chart.hasUserSize = null;\r\n      if (state.chart.chart.series[0] && state.chart.chart.series[0].data.length === 0)\r\n         state.chart.chart.showLoading();\r\n      else\r\n         state.chart.chart.hideLoading();\r\n   };\r\n\r\n   get_chart_data(state, root).then(() => {\r\n      if(state.table.sell_time)\r\n         state.chart.chart.addPlotLineX({ value: state.table.sell_time*1000, label: 'Sell Time'.i18n()});\r\n   });\r\n\r\n   /* backend doesn't always retun the sell_price when contract is soled,\r\n         TODO: remove this when it does */\r\n   liveapi.events.on_till('transaction', (data) => {\r\n      const transaction = data.transaction;\r\n      if(transaction.action === 'sell' && transaction.contract_id == state.contract_id) {\r\n         liveapi.send({proposal_open_contract: 1, contract_id: state.contract_id})\r\n            .then((_data) => update_indicative(_data, state))\r\n            .catch((err) => console.error(err));\r\n         return true; // unsubscribe\r\n      }\r\n   });\r\n\r\n   return state;\r\n}\r\n\r\nconst update_live_chart = (state, granularity) => {\r\n   const key = chartingRequestMap.keyFor(state.chart.symbol, granularity);\r\n   if(!chartingRequestMap[key]){\r\n      const req = {\r\n         symbol: state.chart.symbol,\r\n         subscribe: 1,\r\n         granularity: granularity,\r\n         style: granularity === 0 ? 'ticks' : 'candles',\r\n      };\r\n      chartingRequestMap.register(req)\r\n         .catch((err) => {\r\n            $.growl.error({ message: err.message });\r\n            console.error(err);\r\n         });\r\n   }\r\n   /* don't register if already someone else has registered for this symbol */\r\n   else { chartingRequestMap.subscribe(key); }\r\n\r\n   let on_tick = undefined;\r\n   let on_candles = undefined;\r\n\r\n   if(granularity === 0) {\r\n      let perv_tick = null;\r\n      on_tick = liveapi.events.on('tick', (data) => {\r\n         if (!data.tick || data.tick.symbol !== state.chart.symbol)\r\n            return;\r\n         const chart = state.chart.chart;\r\n         const tick = data.tick;\r\n         chart && chart.series[0].addPoint([tick.epoch*1000, tick.quote*1]);\r\n         /* stop updating when contract is expired */\r\n         if(tick.epoch*1 > state.table.date_expiry*1) {\r\n            if(perv_tick) {\r\n               state.table.exit_tick = perv_tick.quote;\r\n               state.table.exit_tick_time = perv_tick.epoch*1;\r\n               state.validation = 'This contract has expired'.i18n();\r\n               state.table.is_ended = true;\r\n            }\r\n            clean_up();\r\n         }\r\n         perv_tick = tick;\r\n      });\r\n   }\r\n   else {\r\n      on_candles = liveapi.events.on('ohlc', (data) => {\r\n         const data_key = chartingRequestMap.keyFor(data.ohlc.symbol, data.ohlc.granularity);\r\n         if(key != data_key)\r\n            return;\r\n         const chart = state.chart.chart;\r\n         if(!chart)\r\n            return;\r\n\r\n         const series = chart.series[0];\r\n         const last = series.data[series.data.length - 1];\r\n\r\n         const c = data.ohlc;\r\n         const ohlc = [c.open_time*1000, c.open*1, c.high*1, c.low*1, c.close*1];\r\n\r\n         if(last.x != ohlc[0]) {\r\n            series.addPoint(ohlc, true, true);\r\n         }\r\n         else {\r\n            last.update(ohlc,true);\r\n         }\r\n         /* stop updating when contract is expired */\r\n         if(c.epoch*1 > state.table.date_expiry*1) {\r\n            clean_up();\r\n         }\r\n      });\r\n   }\r\n\r\n   let clean_up_done = false;\r\n   const clean_up = () => {\r\n      if(clean_up_done) return;\r\n      clean_up_done = true;\r\n      chartingRequestMap.unregister(key);\r\n      on_tick && liveapi.events.off('tick', on_tick);\r\n      on_candles && liveapi.events.off('candles', on_candles);\r\n   };\r\n   state.onclose.push(clean_up); /* clean up */\r\n}\r\n\r\nconst get_chart_data = (state, root) => {\r\n   const table = state.table;\r\n   const duration = Math.min(state.table.date_expiry*1, moment.utc().unix()) - (state.table.purchase_time || state.table.date_start);\r\n   let granularity = 0;\r\n   let margin = 0; // time margin\r\n   if(duration <= 60*60) { granularity = 0; } // 1 hour\r\n   else if(duration <= 2*60*60) { granularity = 60; } // 2 hours\r\n   else if(duration <= 6*60*60) { granularity = 120; } // 6 hours\r\n   else if(duration <= 24*60*60) { granularity = 300; } // 1 day\r\n   else { granularity = 3600 } // more than 1 day\r\n   margin = granularity === 0 ? Math.max(3, 30*duration/(60*60) | 0) : 3*granularity;\r\n   const request = {\r\n      ticks_history: state.chart.symbol,\r\n      start: (state.table.purchase_time || state.table.date_start)*1 - margin, /* load around 2 more thicks before start */\r\n      end: state.table.sell_time ? state.table.sell_time*1 + margin : state.table.date_expiry ? state.table.date_expiry*1 + margin : 'latest',\r\n      style: 'ticks',\r\n      count: 4999, /* maximum number of ticks possible */\r\n   };\r\n   if(granularity !== 0) {\r\n      request.granularity = granularity;\r\n      request.style = 'candles';\r\n      state.chart.type = 'candles';\r\n   }\r\n\r\n   if(!state.table.is_ended) {\r\n      update_live_chart(state, granularity);\r\n   }\r\n\r\n   return liveapi.send(request).then((data) => {\r\n      state.chart.loading = '';\r\n\r\n      const options = { title: state.chart.display_name };\r\n      if(data.history) options.history = data.history;\r\n      if(data.candles) options.candles = data.candles;\r\n      const chart = init_chart(root, state, options);\r\n\r\n      if(data.history && !state.table.entry_tick_time) {\r\n         state.table.entry_tick_time = data.history.times.filter((t) => (t*1 > state.table.date_start*1) )[0];\r\n         if(!state.table.entry_tick) {\r\n            state.table.entry_tick = data.history.prices.filter(\r\n               (p,inx) => (data.history.times[inx]*1 > state.table.date_start*1)\r\n            )[0];\r\n         }\r\n      }\r\n      /* TODO: see if back-end is going to give uss (entry/exit)_tick and (entry/exit)_tick_time fileds or not! */\r\n      if((data.candles && !state.table.entry_tick_time) || state.table.contract_type.indexOf(\"SPREAD\") === 0) {\r\n         state.table.entry_tick = undefined; // reseting value for calculation.\r\n         get_tick_value(state.chart.symbol, state.table.date_start).then((data) => {\r\n            const history = data.history;\r\n            if(history.times.length !== 1) return;\r\n            state.table.entry_tick_time = history.times[0];\r\n\r\n            if(state.table.contract_type.indexOf(\"SPREAD\") === 0){\r\n               liveapi.send(state.table.request). then((_data) => {\r\n                  state.table.spread = _data.proposal.spread;\r\n                  state.table.decPlaces = ((/^\\d+(\\.\\d+)?$/).exec(history.prices[0])[1] || '-').length - 1;\r\n                  state.table.entry_tick = parseFloat(history.prices[0]* 1 + state.table.direction * state.table.spread / 2);\r\n                  state.table.stop_loss_level = state.table.entry_tick + state.table.stop_loss / (state.table.is_point ? 1 : state.table.per_point) * (- state.table.direction);\r\n                  state.table.stop_profit_level = state.table.entry_tick + state.table.stop_profit / (state.table.is_point ? 1 : state.table.per_point) * (state.table.direction);\r\n                  if(state.table.is_sold){\r\n                     state.table.exit_tick = state.table.entry_tick + state.table.profit_point * state.table.direction; // Above is here.\r\n                  }\r\n                  // unsubscribe\r\n                  liveapi.send({forget: _data.proposal.id});\r\n               }).catch((err) => console.error(err));\r\n            }\r\n\r\n            chart.addPlotLineX({ value: state.table.entry_tick_time*1000, label: 'Entry Spot'.i18n()});\r\n         });\r\n      }\r\n      if(data.history && !state.table.exit_tick_time && state.table.is_ended && state.table.contract_type != \"SPREAD\") {\r\n         state.table.exit_tick_time = _.last(data.history.times.filter((t) => (t*1 <= state.table.date_expiry*1)));\r\n         state.table.exit_tick = _.last(data.history.prices.filter((p, inx) => (data.history.times[inx]*1 <= state.table.date_expiry*1)));\r\n      }\r\n      if(data.candles && !state.table.exit_tick_time && state.table.is_ended) {\r\n         get_tick_value(state.chart.symbol, state.table.date_expiry -2).then((data) => {\r\n            const history = data.history;\r\n            if(history.times.length !== 1) return;\r\n            state.table.exit_tick_time = history.times[0];\r\n\r\n            // Already set the value for exit tick above.\r\n            if(state.table.contract_type.indexOf(\"SPREAD\") === 0){\r\n               return;\r\n            }\r\n\r\n            state.table.exit_tick = history.prices[0];\r\n            !state.table.user_sold && chart.addPlotLineX({ value: state.table.exit_tick_time*1000, label: 'Exit Spot'.i18n(), text_left: true});\r\n         });\r\n      }\r\n\r\n      state.table.purchase_time && chart.addPlotLineX({ value: state.table.purchase_time*1000, label: 'Purchase Time'.i18n()});\r\n\r\n      state.table.entry_tick_time && chart.addPlotLineX({ value: state.table.entry_tick_time*1000, label: 'Entry Spot'.i18n()});\r\n      !state.table.user_sold && state.table.exit_tick_time && chart.addPlotLineX({ value: state.table.exit_tick_time*1000, label: 'Exit Spot'.i18n(), text_left: true});\r\n\r\n      !state.table.user_sold && state.table.date_expiry && chart.addPlotLineX({ value: state.table.date_expiry*1000, label: 'End Time'.i18n()});\r\n      state.table.date_start && chart.addPlotLineX({ value: state.table.date_start*1000, label: 'Start Time'.i18n() ,text_left: true });\r\n\r\n      state.chart.barrier && chart.addPlotLineY({value: state.chart.barrier*1, label: 'Barrier ('.i18n() + state.chart.barrier + ')'});\r\n      state.chart.high_barrier && chart.addPlotLineY({value: state.chart.high_barrier*1, label: 'High Barrier ('.i18n() + state.chart.high_barrier + ')'});\r\n      state.chart.low_barrier && chart.addPlotLineY({value: state.chart.low_barrier*1, label: 'Low Barrier ('.i18n() + state.chart.low_barrier + ')', color: 'red'});\r\n\r\n      state.chart.chart = chart;\r\n      state.chart.manual_reflow();\r\n   })\r\n      .catch((err) => {\r\n         state.chart.loading = err.message;\r\n         console.error(err);\r\n      });\r\n}\r\n\r\nexport default  { init };\r\n"]}