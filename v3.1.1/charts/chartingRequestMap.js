define(["exports","lokijs","lodash","jquery","websockets/binary_websockets","jquery-growl","common/util"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.digits_after_decimal=a.removeChart=a.unregister=a.subscribe=a.register=a.keyFor=a.processOHLC=a.barsLoaded=a.barsTable=void 0;var g=f(b),h=f(c),i=f(d),j=f(e),k=new g["default"],l=a.barsTable=k.addCollection("bars_table"),m=a.barsLoaded=function(a){var b=a;if(this[b]&&this[b].chartIDs){var c=this[b].chartIDs,d=this.processOHLC;c.forEach(function(a){if(a&&i["default"](a.containerIDWithHash).highcharts()){var c=i["default"](a.containerIDWithHash).highcharts().get(b),e=i["default"](a.containerIDWithHash).data("type"),f=i["default"](a.containerIDWithHash).data("timePeriod");if(c){var g=c.data[c.data.length-1].x||c.data[c.data.length-1].time,h=l.chain().find({instrumentCdAndTp:b}).where(function(a){return a.time>=g}).simplesort("time",!1).data();for(var j in h){for(var k=h[j],m=void 0,n=c.data.length-1;n>=0;n--){var o=c.data[n];if(o&&k.time==(o.x||o.time)){m=o;break}}m?e&&isDataTypeClosePriceOnly(e)?m.update([k.time,k.close],!1):m.update([k.time,k.open,k.high,k.low,k.close],!1):e&&isDataTypeClosePriceOnly(e)?c.addPoint([k.time,k.close],!1,!0):c.addPoint([k.time,k.open,k.high,k.low,k.close],!1,!0)}c.isDirty=!0,c.isDirtyData=!0,c.chart.redraw()}else{var p=i["default"](a.containerIDWithHash).highcharts(),q=[],r=l.chain().find({instrumentCdAndTp:b}).simplesort("time",!1).data();for(var s in r)d(r[s].open,r[s].high,r[s].low,r[s].close,r[s].time,e,q);if(!p||0===q.length)return;var t=30;isTick(f)&&(t=200);var u=q.length,v=q.length>t?u-t:0,w=a.instrumentName,x=a.series_compare,y=0;p.series.forEach(function(a){a.options.isInstrument&&"navigator"!==a.options.id&&++y}),0===y&&(p.xAxis[0].range=q[u-1][0]-q[v][0]);var z={id:b,name:w,data:q,type:e?e:"candlestick",dataGrouping:{enabled:!1},compare:x,states:{hover:{enabled:!1}},isInstrument:!0};(isLineDotType(e)||isDotType(e))&&(z.type="line",isDotType(e)&&(z.dashStyle="dot"),z.marker={enabled:!isDotType(e),radius:4}),p.addSeries(z)}}})}},n=a.processOHLC=function(a,b,c,d,e,f,g){if(!(g.length>0&&g[g.length-1][0]>e))if(f&&isDataTypeClosePriceOnly(f)){if(!i["default"].isNumeric(e)||!i["default"].isNumeric(d))return;g.push([e,d])}else{if(!(i["default"].isNumeric(e)&&i["default"].isNumeric(a)&&i["default"].isNumeric(b)&&i["default"].isNumeric(c)&&i["default"].isNumeric(d)))return;g.push([e,a,b,c,d])}},o=a.keyFor=function(a,b){var c=b||0;return"string"==typeof c&&(c=convertToTimeperiodObject(c).timeInSeconds()),(a+c).toUpperCase()},p=a.register=function(a){var b=this,c=b.keyFor(a.symbol,a.granularity),d=a.granularity||0,e=0!=d&&a.style?a.style:"ticks",f=!0;"string"==typeof d&&("0"==i["default"].trim(d)||("1t"==i["default"].trim(d).toLowerCase()?d=convertToTimeperiodObject(d).timeInSeconds():(f=!1,d=convertToTimeperiodObject(d).timeInSeconds())));var g={ticks_history:a.symbol,granularity:d,count:a.count||1,end:"latest",style:e};if(1===a.subscribe&&(g.subscribe=1),!f){var h=a.count||1,k=(new Date).getTime()/1e3-h*d|0,l=new Date;l.setUTCFullYear(l.getUTCFullYear()-3),l.setDate(l.getDate()+1),1e3*k<l.getTime()&&(k=l.getTime()/1e3|0),g.style="candles",g.start=k,g.adjust_start_time=a.adjust_start_time||1}return b[c]={symbol:a.symbol,granularity:d,subscribers:0,chartIDs:[]},g.subscribe&&(b[c].subscribers=1),j["default"].send(g,3e4)["catch"](function(d){if(g.subscribe&&"MarketIsClosed"==d.code)return i["default"].growl.notice({message:a.symbol+" market is presently closed.".i18n()}),delete g.subscribe,b[c].subscribers-=1,j["default"].send(g,3e4);throw delete b[c],d})},q=a.subscribe=function(a,b){var c=this;c[a]&&(c[a].subscribers+=1,b&&c[a].chartIDs.push(b))},r=a.unregister=function(a,b){var c=this;c[a]&&(b&&h["default"].remove(c[a].chartIDs,{containerIDWithHash:b}),c[a].subscribers-=1,0===c[a].chartIDs.length&&c[a].timerHandler&&(clearInterval(c[a].timerHandler),c[a].timerHandler=null),0===c[a].subscribers&&c[a].id&&j["default"].send({forget:c[a].id})["catch"](function(a){}),0===c[a].subscribers&&delete c[a])},s=a.removeChart=function(a,b){var c=this;c[a]&&h["default"](c[a].chartIDs).map("containerIDWithHash").includes(b)&&(c[a].subscribers-=1,h["default"].remove(c[a].chartIDs,{containerIDWithHash:b}))},t=a.digits_after_decimal=function(a,b){if(a=a&&a+"",!a){var c=this.keyFor(b,0),d=0;return l.chain().find({instrumentCdAndTp:c}).simplesort("time",!0).limit(10).data().forEach(function(a){var b=a.close+"",c=b.substring(b.indexOf(".")+1).length;c>d&&(d=c)}),d}return a.substring(a.indexOf(".")+1).length};a["default"]={barsLoaded:m,processOHLC:n,keyFor:o,barsTable:l,register:p,subscribe:q,unregister:r,removeChart:s,digits_after_decimal:t}});