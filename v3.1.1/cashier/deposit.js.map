{"version":3,"sources":["../../../../src/cashier/deposit.es6"],"names":["init","require","deposit_win","deposit_win_view","error_handler","err","console","error","growl","message","li","click","Promise","all","cached","authorize","then","data","currency","local_storage","get","check_currency","init_deposit_win","catch","moveToTop","root","i18n","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","height","close","dialog","trigger","remove","open","destroy","unbind","init_state","offset","top","my","left","at","css","fixFooterPosition","track","module_id","is_unique","app_id","state","route","value","empty_fields","validate","clear","debounce","show","user","email","cashier_url","residence","residence_name","standard_methods","iframe_visible","payment_agents","list","current","update","iframe_loaded","get_commission_text","agent","deposit_commission","withdrawal_commission","onclick","e","elem","target","next","cur_elem","is_active","scrollHeight","bind","send","cashier","code","init_win","error_text","residence_promise","get_settings","country_code","country","paymentagent_list","map","commission_text","supported_banks","toLowerCase","split"],"mappings":";;;;;;YAyBgBA,I,GAAAA,I;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAzBhB;;;;AAeAC,YAAQ,CAAC,2BAAD,CAAR;AACAA,YAAQ,CAAC,yBAAD,CAAR;AACA,QAAIC,cAAc,IAAlB;AACA,QAAIC,mBAAmB,IAAvB,C,CAA6B;;AAE7B,QAAMC,gBAAgB,SAAhBA,aAAgB,CAASC,GAAT,EAAc;AAChCC,gBAAQC,KAAR,CAAcF,GAAd;AACA,yBAAEG,KAAF,CAAQD,KAAR,CAAc,EAAEE,SAASJ,IAAII,OAAf,EAAd;AACH,KAHD;;AAKO,aAAST,IAAT,CAAcU,EAAd,EAAkB;AACrBA,WAAGC,KAAH,CAAS,YAAM;AACX,gBAAI,CAACT,WAAL,EAAkB;AACdU,wBAAQC,GAAR,CAAY,CAAC,4BAAQC,MAAR,CAAeC,SAAf,EAAD,EAA6B,qBAAmBf,IAAnB,CAAwB,SAAxB,CAA7B,CAAZ,EAA8EgB,IAA9E,CAAmF,gBAAQ;AACvF,wBAAI,CAACC,KAAK,CAAL,EAAQF,SAAR,CAAkBG,QAAnB,IAA+B,CAACC,cAAcC,GAAd,CAAkB,UAAlB,CAApC,EAAmE;AAC/D,+BAAO,mBAAeC,cAAf,EAAP;AACJ,2BAAO,IAAP,CAHuF,CAG1E;AAChB,iBAJD,EAIGL,IAJH,CAIQ,YAAM;AACVM;AACH,iBAND,EAMGC,KANH,CAMSnB,aANT;AAOH,aARD,MASIF,YAAYsB,SAAZ;AACP,SAXD;AAYH;;AAED,aAASF,gBAAT,CAA0BG,IAA1B,EAAgC;AAC5BA,eAAO,sBAAEA,IAAF,EAAQC,IAAR,EAAP;AACAxB,sBAAc,kBAAQyB,iBAAR,CAA0BF,IAA1B,EAAgC;AAC1CG,mBAAO,eADmC;AAE1CC,uBAAW,IAF+B;AAG1CC,yBAAa,KAH6B;AAI1CC,yBAAa,IAJ6B;AAK1CC,yBAAa,IAL6B;AAM1CC,mBAAO,GANmC;AAO1CC,oBAAQ,GAPkC;AAQ1C,+BAAmB,IARuB;AAS1CC,mBAAO,iBAAW;AACdjC,4BAAYkC,MAAZ,CAAmB,SAAnB;AACAlC,4BAAYmC,OAAZ,CAAoB,aAApB,EAFc,CAEsB;AACpCnC,4BAAYoC,MAAZ;AACApC,8BAAc,IAAd;AACH,aAdyC;AAe1CqC,kBAAM,gBAAW,CAAE,CAfuB;AAgB1CC,qBAAS,mBAAW;AAChBrC,oCAAoBA,iBAAiBsC,MAAjB,EAApB;AACAtC,mCAAmB,IAAnB;AACH;AAnByC,SAAhC,CAAd;;AAsBAuC,mBAAWjB,IAAX;AACAvB,oBAAYkC,MAAZ,CAAmB,MAAnB;;AAEA;AACA,YAAIO,SAASzC,YAAYkC,MAAZ,CAAmB,QAAnB,EAA6BO,MAA7B,EAAb;AACAA,eAAOC,GAAP,GAAa,GAAb;AACA1C,oBAAYkC,MAAZ,CAAmB,QAAnB,EAA6B,UAA7B,EAAyC,EAAES,IAAIF,OAAOG,IAAb,EAAmBC,IAAIJ,OAAOC,GAA9B,EAAzC;AACA1C,oBAAYkC,MAAZ,CAAmB,QAAnB,EAA6BY,GAA7B,CAAiC;AAC7BF,kBAAMH,OAAOG,IAAP,GAAc,IADS;AAE7BF,iBAAKD,OAAOC,GAAP,GAAa;AAFW,SAAjC;AAIA1C,oBAAY+C,iBAAZ;AACA/C,oBAAYgD,KAAZ,CAAkB;AACdC,uBAAW,SADG;AAEdC,uBAAW;AAFG,SAAlB;AAIH;;AAED,aAASV,UAAT,CAAoBjB,IAApB,EAA0B;AACtB,YAAI4B,SAAS,4BAAQA,MAArB;AACA,YAAIC,QAAQ;AACRC,mBAAO,EAAEC,OAAO,kBAAT,EADC;AAERC,0BAAc;AACVC,0BAAU,KADA;AAEVC,uBAAO,iBAAEC,QAAF,CAAW,YAAW;AACzBN,0BAAMG,YAAN,CAAmBC,QAAnB,GAA8B,KAA9B;AACH,iBAFM,EAEJ,IAFI,CAFG;AAKVG,sBAAM,gBAAW;AACbP,0BAAMG,YAAN,CAAmBC,QAAnB,GAA8B,IAA9B;AACAJ,0BAAMG,YAAN,CAAmBE,KAAnB;AACH;AARS,aAFN;AAYRG,kBAAM;AACFC,uBAAO5C,cAAcC,GAAd,CAAkB,WAAlB,EAA+B2C,KADpC;AAEFC,6BAAa,EAFX;AAGFC,2BAAW,EAHT;AAIFC,gCAAgB;AAJd,aAZE;AAkBRC,8BAAkB;AACdC,gCAAgB;AADF,aAlBV;AAqBRC,4BAAgB;AACZC,sBAAM,EADM;AAEZC,yBAAS;AAFG;AArBR,SAAZ;;AA2BAjB,cAAMC,KAAN,CAAYiB,MAAZ,GAAqB,iBAAS;AAAElB,kBAAMC,KAAN,CAAYC,KAAZ,GAAoBD,KAApB;AAA4B,SAA5D;;AAEAD,cAAMa,gBAAN,CAAuBM,aAAvB,GAAuC,YAAW;AAC9C,gBAAInB,MAAMQ,IAAN,CAAWE,WAAf,EACIV,MAAMa,gBAAN,CAAuBC,cAAvB,GAAwC,IAAxC;AACP,SAHD;;AAKAd,cAAMe,cAAN,CAAqBK,mBAArB,GAA2C,UAASC,KAAT,EAAgB;AACvD,gBAAIA,MAAMC,kBAAN,KAA6BD,MAAME,qBAAvC,EAA8D;AAC1D,uBAAOF,MAAMC,kBAAN,GAA2B,IAA3B,GAAkC,aAAalD,IAAb,EAAzC;AACH;AACD,mBAAOiD,MAAMC,kBAAN,GAA2B,IAA3B,GAAkC,WAAWlD,IAAX,EAAlC,GAAsD,KAAtD,GACHiD,MAAME,qBADH,GAC2B,IAD3B,GACkC,cAAcnD,IAAd,EADzC;AAEH,SAND;AAOA4B,cAAMe,cAAN,CAAqBS,OAArB,GAA+B,UAASH,KAAT,EAAgBI,CAAhB,EAAmB;AAC9C,gBAAIC,OAAO,sBAAED,EAAEE,MAAJ,EAAYC,IAAZ,EAAX;AACA,gBAAIC,WAAW7B,MAAMe,cAAN,CAAqBW,IAApC;AACAG,wBAAYA,SAASnC,GAAT,CAAa,YAAb,EAA2B,GAA3B,CAAZ;AACAM,kBAAMe,cAAN,CAAqBE,OAArB,CAA6Ba,SAA7B,GAAyC,KAAzC;AACA,gBAAI9B,MAAMe,cAAN,CAAqBE,OAArB,KAAiCI,KAArC,EAA4C;AACxCrB,sBAAMe,cAAN,CAAqBE,OAArB,GAA+B,EAA/B;AACH,aAFD,MAEO;AACHjB,sBAAMe,cAAN,CAAqBE,OAArB,GAA+BI,KAA/B;AACArB,sBAAMe,cAAN,CAAqBW,IAArB,GAA4BA,IAA5B;AACAA,qBAAKhC,GAAL,CAAS,YAAT,EAAuBgC,KAAK,CAAL,EAAQK,YAAR,GAAuB,IAA9C;AACAV,sBAAMS,SAAN,GAAkB,IAAlB;AACH;AACJ,SAbD;;AAeAjF,2BAAmB,sBAAGmF,IAAH,CAAQ7D,KAAK,CAAL,CAAR,EAAiB6B,KAAjB,CAAnB;;AAEA;AACA,oCAAQiC,IAAR,CAAa;AACTC,qBAAS;AADA,SAAb,EAEGxE,IAFH,CAEQ,UAASC,IAAT,EAAe;AACnBqC,kBAAMQ,IAAN,CAAWE,WAAX,GAAyB/C,KAAKuE,OAA9B;AACH,SAJD,EAIGjE,KAJH,CAIS,UAAClB,GAAD,EAAS;AACd,gBAAIA,IAAIoF,IAAJ,KAAa,yBAAjB,EAA4C;AACxCvF,4BAAYkC,MAAZ,CAAmB,OAAnB;AACA,8CAAesD,QAAf,GAA0B1E,IAA1B,CAA+B,YAAM;AACjCM;AACH,iBAFD,EAEGC,KAFH,CAES,eAAO;AACZnB,kCAAcC,GAAd;AACH,iBAJD;AAKA;AACH;AACDiD,kBAAMqC,UAAN,GAAmBtF,IAAII,OAAvB;AACH,SAfD;;AAiBA;AACA,YAAImF,oBAAoB,4BAAQL,IAAR,CAAa,EAAEM,cAAc,CAAhB,EAAb,EACnB7E,IADmB,CACd,UAASC,IAAT,EAAe;AACjBqC,kBAAMQ,IAAN,CAAWG,SAAX,GAAuBhD,KAAK4E,YAAL,CAAkBC,YAAzC;AACAxC,kBAAMQ,IAAN,CAAWI,cAAX,GAA4BjD,KAAK4E,YAAL,CAAkBE,OAA9C;AACH,SAJmB,EAKnBxE,KALmB,CAKbnB,aALa,CAAxB;;AAOA;AACAwF,0BAAkB5E,IAAlB,CAAuB,YAAW;AAC9B,gBAAI,CAACsC,MAAMQ,IAAN,CAAWG,SAAhB,EACI,OAAO,EAAE+B,mBAAmB,EAAE1B,MAAM,EAAR,EAArB,EAAP;AACJ,mBAAO,4BAAQiB,IAAR,CAAa,EAAES,mBAAmB1C,MAAMQ,IAAN,CAAWG,SAAhC,EAAb,CAAP;AACH,SAJD,EAIGjD,IAJH,CAIQ,UAASC,IAAT,EAAe;AACnB,gBAAIqD,OAAOrD,KAAK+E,iBAAL,CAAuB1B,IAAvB,CAA4B2B,GAA5B,CAAgC,UAAStB,KAAT,EAAgB;AACvDA,sBAAMuB,eAAN,GAAwB5C,MAAMe,cAAN,CAAqBK,mBAArB,CAAyCC,KAAzC,CAAxB;AACAA,sBAAMwB,eAAN,GAAwBxB,MAAMwB,eAAN,CAAsBC,WAAtB,GAAoCC,KAApC,CAA0C,GAA1C,CAAxB;AACA,uBAAO1B,KAAP;AACH,aAJU,CAAX;AAKArB,kBAAMe,cAAN,CAAqBC,IAArB,GAA4BA,IAA5B;AACH,SAXD,EAWG/C,KAXH,CAWSnB,aAXT;AAYH;;sBAEc;AACXJ,cAAMA;AADK,K","file":"deposit.js","sourcesContent":["/*\r\n * Created by amin on June 26, 2016.\r\n */\r\n\r\nimport $ from 'jquery';\r\nimport liveapi from 'websockets/binary_websockets';\r\nimport windows from 'windows/windows';\r\nimport currencyDialog from 'cashier/currency';\r\nimport rv from 'common/rivetsExtra';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport tncApprovalWin from \"cashier/uk_funds_protection\"\r\nimport html from 'text!cashier/deposit.html';\r\nimport checkAccountStatus from 'shownotice/shownotice';\r\n\r\nrequire(['text!cashier/deposit.html']);\r\nrequire(['css!cashier/deposit.css']);\r\nlet deposit_win = null;\r\nlet deposit_win_view = null; // rivets view\r\n\r\nconst error_handler = function(err) {\r\n    console.error(err);\r\n    $.growl.error({ message: err.message });\r\n};\r\n\r\nexport function init(li) {\r\n    li.click(() => {\r\n        if (!deposit_win) {\r\n            Promise.all([liveapi.cached.authorize(), checkAccountStatus.init(\"deposit\")]).then(data => {\r\n                if (!data[0].authorize.currency || !local_storage.get(\"currency\")) // if currency is not set ask for currency\r\n                    return currencyDialog.check_currency();\r\n                return true; // OK\r\n            }).then(() => {\r\n                init_deposit_win(html);\r\n            }).catch(error_handler);\r\n        } else\r\n            deposit_win.moveToTop();\r\n    });\r\n}\r\n\r\nfunction init_deposit_win(root) {\r\n    root = $(root).i18n();\r\n    deposit_win = windows.createBlankWindow(root, {\r\n        title: 'Deposit funds',\r\n        resizable: true,\r\n        collapsable: false,\r\n        minimizable: true,\r\n        maximizable: true,\r\n        width: 700,\r\n        height: 600,\r\n        'data-authorized': true,\r\n        close: function() {\r\n            deposit_win.dialog('destroy');\r\n            deposit_win.trigger('dialogclose'); // TODO: figure out why event is not fired.\r\n            deposit_win.remove();\r\n            deposit_win = null;\r\n        },\r\n        open: function() {},\r\n        destroy: function() {\r\n            deposit_win_view && deposit_win_view.unbind();\r\n            deposit_win_view = null;\r\n        }\r\n    });\r\n\r\n    init_state(root);\r\n    deposit_win.dialog('open');\r\n\r\n    /* update dialog position, this way when dialog is resized it will not move*/\r\n    var offset = deposit_win.dialog('widget').offset();\r\n    offset.top = 110;\r\n    deposit_win.dialog(\"option\", \"position\", { my: offset.left, at: offset.top });\r\n    deposit_win.dialog('widget').css({\r\n        left: offset.left + 'px',\r\n        top: offset.top + 'px'\r\n    });\r\n    deposit_win.fixFooterPosition();\r\n    deposit_win.track({\r\n        module_id: 'deposit',\r\n        is_unique: true\r\n    });\r\n}\r\n\r\nfunction init_state(root) {\r\n    var app_id = liveapi.app_id;\r\n    var state = {\r\n        route: { value: 'standard-methods' },\r\n        empty_fields: {\r\n            validate: false,\r\n            clear: _.debounce(function() {\r\n                state.empty_fields.validate = false;\r\n            }, 4000),\r\n            show: function() {\r\n                state.empty_fields.validate = true;\r\n                state.empty_fields.clear();\r\n            }\r\n        },\r\n        user: {\r\n            email: local_storage.get('authorize').email,\r\n            cashier_url: '',\r\n            residence: '',\r\n            residence_name: ''\r\n        },\r\n        standard_methods: {\r\n            iframe_visible: false,\r\n        },\r\n        payment_agents: {\r\n            list: [],\r\n            current: {}\r\n        }\r\n    };\r\n\r\n    state.route.update = route => { state.route.value = route; };\r\n\r\n    state.standard_methods.iframe_loaded = function() {\r\n        if (state.user.cashier_url)\r\n            state.standard_methods.iframe_visible = true;\r\n    }\r\n\r\n    state.payment_agents.get_commission_text = function(agent) {\r\n        if (agent.deposit_commission === agent.withdrawal_commission) {\r\n            return agent.deposit_commission + '% ' + 'commission'.i18n();\r\n        }\r\n        return agent.deposit_commission + '% ' + 'deposits'.i18n() + ' / ' +\r\n            agent.withdrawal_commission + '% ' + 'withdrawals'.i18n();\r\n    }\r\n    state.payment_agents.onclick = function(agent, e) {\r\n        var elem = $(e.target).next();\r\n        var cur_elem = state.payment_agents.elem;\r\n        cur_elem && cur_elem.css('max-height', '0');\r\n        state.payment_agents.current.is_active = false;\r\n        if (state.payment_agents.current === agent) {\r\n            state.payment_agents.current = {};\r\n        } else {\r\n            state.payment_agents.current = agent;\r\n            state.payment_agents.elem = elem;\r\n            elem.css('max-height', elem[0].scrollHeight + 'px');\r\n            agent.is_active = true;\r\n        }\r\n    }\r\n\r\n    deposit_win_view = rv.bind(root[0], state);\r\n\r\n    /* get the cashier_url */\r\n    liveapi.send({\r\n        cashier: 'deposit'\r\n    }).then(function(data) {\r\n        state.user.cashier_url = data.cashier;\r\n    }).catch((err) => {\r\n        if (err.code === \"ASK_UK_FUNDS_PROTECTION\") {\r\n            deposit_win.dialog(\"close\");\r\n            tncApprovalWin.init_win().then(() => {\r\n                init_deposit_win(html);\r\n            }).catch(err => {\r\n                error_handler(err);\r\n            });\r\n            return;\r\n        }\r\n        state.error_text = err.message;\r\n    });\r\n\r\n    /* get the residence field and its states */\r\n    var residence_promise = liveapi.send({ get_settings: 1 })\r\n        .then(function(data) {\r\n            state.user.residence = data.get_settings.country_code;\r\n            state.user.residence_name = data.get_settings.country;\r\n        })\r\n        .catch(error_handler);\r\n\r\n    /* get payment agents list */\r\n    residence_promise.then(function() {\r\n        if (!state.user.residence)\r\n            return { paymentagent_list: { list: [] } };\r\n        return liveapi.send({ paymentagent_list: state.user.residence });\r\n    }).then(function(data) {\r\n        var list = data.paymentagent_list.list.map(function(agent) {\r\n            agent.commission_text = state.payment_agents.get_commission_text(agent);\r\n            agent.supported_banks = agent.supported_banks.toLowerCase().split(',');\r\n            return agent;\r\n        })\r\n        state.payment_agents.list = list;\r\n    }).catch(error_handler);\r\n}\r\n\r\nexport default {\r\n    init: init\r\n}\r\n"]}